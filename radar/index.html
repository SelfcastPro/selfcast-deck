<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Selfcast Casting Radar – V2.1</title>
<meta name="robots" content="noindex,nofollow" />
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; background:#0b0b0b; color:#f5f5f5; }
  a { color: inherit; }
  .wrap { max-width: 1400px; margin: 0 auto; }
  h1 { margin: 8px 0 6px; font-size: 28px; font-weight: 900; }
  .meta { color:#b3b3b3; font-size:12px; margin-bottom: 14px; }
  .controls { display: flex; gap: 12px; flex-wrap: wrap; margin: 12px 0 20px; }
  input, select, label { padding: 8px; border: 1px solid #222; background:#141414; color:#f5f5f5; border-radius: 10px; }
  label.chk { display:flex; align-items:center; gap:8px; border:none; }
  table { width: 100%; border-collapse: collapse; background:#141414; border-radius: 12px; overflow:hidden; }
  th, td { text-align: left; padding: 10px; border-bottom: 1px solid #222; vertical-align: top; }
  tr:hover { background: #161616; }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#1d1d1d; border:1px solid #222; font-size: 12px; }
  .small { font-size:12px; color:#b3b3b3; }
  .spinner { display:inline-block; width:18px; height:18px; border:2px solid #222; border-top:2px solid #888; border-radius:50%; animation:spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .btn { display:inline-flex; align-items:center; gap:8px; background:#e51c23; border:0; color:#fff; padding:10px 14px; border-radius:10px; text-decoration:none; font-weight:700; }
  .btn.secondary{ background:#1f1f1f; border:1px solid #2a2a2a; color:#fff; }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 id="title">Selfcast Casting Radar – V2.1</h1>
    <div>
      <a class="btn secondary" href="/">← Back to main</a>
    </div>
  </div>
  <div class="meta">Data file: <code id="source-url"></code></div>
  <div id="status" class="small"><span class="spinner"></span> Loading latest data…</div>

  <div class="controls" style="display:none" id="controls">
    <input id="q" type="search" placeholder="Search name, notes, country, city, email, phone…" />
    <select id="country"><option value="">All countries</option></select>
    <select id="type"><option value="">All types</option></select>
    <label class="chk"><input type="checkbox" id="contactsOnly" /> Contacts only</label>
  </div>

  <table id="tbl" style="display:none">
    <thead>
      <tr>
        <th>Name</th>
        <th>Country</th>
        <th>City/Region</th>
        <th>Type</th>
        <th>Contact</th>
        <th>URL</th>
        <th>Notes</th>
        <th>Source</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
// --- OPTIONAL AUTH GUARD (kræver login-cookie fra jeres /api/login) ---
// Slå til ved at ændre requireAuth = true;
const requireAuth = false;
if (requireAuth) {
  const loggedIn = document.cookie.split(';').some(c => c.trim().startsWith('sc_auth=ok'));
  if (!loggedIn) location.href = '/login/';
}

// Helpers
function escapeHtml(s) { return (s||'').replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function escapeAttr(s) { return (s||'').replace(/"/g, '&quot;'); }
function uniqueSorted(arr) { return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b)); }

// Tiny CSV parser (quotes/commas safe)
function parseCSV(text) {
  const rows = []; let row = []; let field = ''; let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const c = text[i], n = text[i+1];
    if (inQuotes) {
      if (c === '"' && n === '"') { field += '"'; i++; continue; }
      if (c === '"') { inQuotes = false; continue; }
      field += c;
    } else {
      if (c === '"') { inQuotes = true; continue; }
      if (c === ',') { row.push(field); field = ''; continue; }
      if (c === '\n') { row.push(field); rows.push(row); row = []; field=''; continue; }
      if (c === '\r') { continue; }
      field += c;
    }
  }
  if (field.length || row.length) { row.push(field); rows.push(row); }
  return rows;
}
function toObjects(rows) {
  if (!rows.length) return [];
  const headers = rows[0].map(h => (h||'').trim());
  return rows.slice(1).map(r => {
    const obj = {};
    headers.forEach((h, idx) => obj[h] = r[idx] ?? '');
    return obj;
  });
}

(async function boot() {
  const $title = document.getElementById('title');
  const $src = document.getElementById('source-url');
  const $status = document.getElementById('status');
  const $controls = document.getElementById('controls');
  const $q = document.getElementById('q');
  const $country = document.getElementById('country');
  const $type = document.getElementById('type');
  const $contactsOnly = document.getElementById('contactsOnly');
  const $tbl = document.getElementById('tbl');
  const $tbody = document.querySelector('#tbl tbody');

  try {
    const cfgRes = await fetch('./config.json', {cache:'no-store'});
    const cfg = await cfgRes.json();
    if (cfg.page_title) $title.textContent = cfg.page_title;
    if (cfg.noindex) document.querySelector('meta[name="robots"]').setAttribute('content','noindex,nofollow');
    const CSV_URL = cfg.csv_url;
    $src.textContent = CSV_URL;

    const res = await fetch(CSV_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    const objs = toObjects(rows);

    const needed = ['display_name','country','city','region','type','notes','url','source_file','sheet','emails_found','phones_found'];
    const DATA = objs.map(o => {
      const obj = {};
      needed.forEach(k => obj[k] = (o[k] ?? '').trim());
      return obj;
    });

    function loadFilters() {
      uniqueSorted(DATA.map(r => r.country)).forEach(c => {
        const o = document.createElement('option'); o.value=c; o.textContent=c; $country.appendChild(o);
      });
      uniqueSorted(DATA.map(r => r.type)).forEach(t => {
        const o = document.createElement('option'); o.value=t; o.textContent=t; $type.appendChild(o);
      });
    }

    function matches(r) {
      const q = $q.value.trim().toLowerCase();
      const cn = $country.value;
      const tp = $type.value;
      const hasContact = (r.emails_found && r.emails_found.length) || (r.phones_found && r.phones_found.length);
      if (cn && r.country !== cn) return false;
      if (tp && r.type !== tp) return false;
      if ($contactsOnly.checked && !hasContact) return false;
      if (!q) return true;
      const hay = [r.display_name,r.country,r.city,r.region,r.type,r.notes,r.url,r.emails_found,r.phones_found,r.source_file,r.sheet].join(' ').toLowerCase();
      return hay.includes(q);
    }

    function render() {
      const rows = DATA.filter(matches).slice(0, 2000);
      $tbody.innerHTML = rows.map(r => `
        <tr>
          <td><strong>${escapeHtml(r.display_name || '')}</strong></td>
          <td>${escapeHtml(r.country || '')}</td>
          <td>${escapeHtml([r.city, r.region].filter(Boolean).join(' / '))}</td>
          <td><span class="pill">${escapeHtml(r.type || '')}</span></td>
          <td>
            ${r.emails_found ? `<div class="small"><strong>Email:</strong> ${escapeHtml(r.emails_found)}</div>` : ''}
            ${r.phones_found ? `<div class="small"><strong>Phone:</strong> ${escapeHtml(r.phones_found)}</div>` : ''}
          </td>
          <td>${r.url ? `<a href="${escapeAttr(r.url)}" target="_blank" rel="noopener">Open</a>` : ''}</td>
          <td>${escapeHtml(r.notes || '')}</td>
          <td class="small">${escapeHtml(r.source_file || '')} • ${escapeHtml(r.sheet || '')}</td>
        </tr>
      `).join('');
    }

    $status.textContent = `Loaded ${objs.length.toLocaleString()} rows`;
    $controls.style.display = 'flex';
    $tbl.style.display = 'table';
    loadFilters();
    render();

    $q.addEventListener('input', render);
    $country.addEventListener('change', render);
    $type.addEventListener('change', render);
    $contactsOnly.addEventListener('change', render);
  } catch (e) {
    document.getElementById('status').textContent = 'Error: ' + e.message;
  }
})();
</script>
</body>
</html>
