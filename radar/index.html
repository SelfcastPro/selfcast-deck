<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Selfcast – Casting Jobs Radar</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{
    --bg:#0b0b0b; --panel:#141414; --muted:#9aa3ab; --line:#222;
    --text:#f5f5f5; --link:#7fb3ff; --accent:#2a2a2a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  a{color:var(--link);text-decoration:none}
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  h1{margin:0 0 8px;font-size:26px;font-weight:900}
  .muted{color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 14px}
  input,select{padding:8px 10px;border:1px solid var(--line);background:var(--panel);color:var(--text);border-radius:10px}
  .layout{display:grid;grid-template-columns: 1.6fr 1fr;gap:12px;align-items:start}
  .table{background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  table{width:100%;border-collapse:collapse;table-layout:fixed}
  th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
  th{background:#111;font-weight:700}
  tr:hover td{background:#161616}
  th:nth-child(1),td:nth-child(1){width:36px;text-align:center}
  th:nth-child(2){width:30%}
  th:nth-child(3){width:9%}
  th:nth-child(4){width:16%}
  th:nth-child(5){width:auto}
  th:nth-child(6),td:nth-child(6){width:110px}
  .title a{font-weight:800}
  .snippet{white-space:pre-wrap;max-height:6.6em;overflow:hidden}
  .side{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;position:sticky;top:14px;max-height:calc(100vh - 28px);overflow:auto}
  .side h2{margin:0 0 6px;font-size:18px}
  .side .meta{display:flex;gap:12px;flex-wrap:wrap;margin:6px 0 12px}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px}
  .btn{background:#1f1f1f;border:1px solid var(--line);padding:8px 10px;border-radius:10px;cursor:pointer;color:var(--text)}
  .btn:hover{background:#232323}
  .fallback{padding:2rem;text-align:center;color:var(--muted)}
  .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;background:#101010}
</style>
</head>
<body>
<div class="wrap">
  <h1>Selfcast – Casting Jobs Radar</h1>
  <div id="meta" class="muted">Loading…</div>

  <div class="controls">
    <input id="q" type="search" placeholder="Search title, snippet, role, city…" />
    <select id="source"><option value="">All sources</option></select>
    <select id="age">
      <option value="">Any time</option>
      <option value="1">Last 24h</option>
      <option value="3">Last 3 days</option>
      <option value="7" selected>Last 7 days</option>
      <option value="14">Last 14 days</option>
      <option value="30">Last 30 days</option>
    </select>
    <select id="sort">
      <option value="new">Newest first</option>
      <option value="old">Oldest first</option>
    </select>
    <label class="muted"><input type="checkbox" id="onlyUnread"> Only unread</label>
  </div>

  <div class="layout">
    <div class="table">
      <table id="tbl">
        <thead>
          <tr>
            <th>✓</th>
            <th>Title</th>
            <th>Country</th>
            <th>Source</th>
            <th>Snippet</th>
            <th>Posted</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="fallback" class="fallback" style="display:none"></div>
    </div>

    <aside class="side" id="preview">
      <div class="muted">Select a post to preview…</div>
    </aside>
  </div>
</div>

<script>
const PATH = "live/jobs.json";                           // samme som crawl skriver
const LS_READ = "radar.read.v1";                        // checkmarks
let READ = JSON.parse(localStorage.getItem(LS_READ) || "{}");

const esc = (s)=> (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
const fmtDate = (d)=> d ? new Date(d).toLocaleDateString("da-DK") : "";
const agoDays = (iso)=> !iso ? Infinity : (Date.now() - new Date(iso).getTime())/86400000;

let DATA=[], FILTERED=[];

// Email template
const MAIL_BODY = `Regarding your casting call on Facebook

Hi

We came across your casting post on Facebook and would love to help.
Please share more details about the role(s) and production so we can present the right candidates for you.

The more info we can give the talents, the better the match:
- Client name
- Role description (gender, age, look, special requirements, photos/videos)
- Rights (e.g. 1 year worldwide, all platforms)
- Salary (total fee incl. buyout)
- Travel expenses (covered? up to 500 EUR?)
- Date(s) (specific day or period)
- Location (country, city/region)

Next time you need talents, you can also book directly through the Selfcast platform.
We currently represent over 60,000 talents in 160+ countries, with a strong base across Europe.

Best regards,
The Selfcast Team
CASTING MADE EASY`;

// Load data
fetch(PATH, { cache: "no-store" })
  .then(r=>r.json())
  .then(json=>{
    DATA = json.items || [];
    document.getElementById("meta").textContent =
      `Loaded ${DATA.length.toLocaleString()} posts · Updated: ${new Date(json.updatedAt || Date.now()).toLocaleString("da-DK")} · live from Apify`;

    // Source filter options
    const $src = document.getElementById("source");
    const unique = [...new Set(DATA.map(x=>x.source||""))].filter(Boolean).sort();
    for (const s of unique) {
      const o = document.createElement("option");
      o.value = s; o.textContent = s;
      $src.appendChild(o);
    }

    applyAndRender();
  })
  .catch(err=>{
    document.getElementById("meta").textContent = "Error loading jobs: " + err.message;
    document.getElementById("fallback").style.display = "block";
    document.getElementById("fallback").textContent = "Could not load data.";
  });

// Filtering
function applyFilters(row){
  const q = document.getElementById("q").value.trim().toLowerCase();
  const src = document.getElementById("source").value;
  const age = document.getElementById("age").value;
  const onlyUnread = document.getElementById("onlyUnread").checked;

  // age: brug ægte postDate (fallback importedAt)
  const postD = row.postDate || row.importedAt;
  if (age && agoDays(postD) > Number(age)) return false;

  if (src && (row.source||"") !== src) return false;

  if (onlyUnread && READ[row.id]) return false;

  if (q){
    const hay = (row.title + " " + row.summary + " " + (row.country||"") + " " + (row.source||"")).toLowerCase();
    if (!hay.includes(q)) return false;
  }

  return true;
}

function sortRows(a,b){
  const s = document.getElementById("sort").value;
  const da = new Date(a.postDate || a.importedAt);
  const db = new Date(b.postDate || b.importedAt);
  return s === "old" ? (da - db) : (db - da);
}

function applyAndRender() {
  FILTERED = DATA.filter(applyFilters).sort(sortRows);
  renderTable(FILTERED);
}

function toggleRead(id, checked){
  if (checked) READ[id] = 1; else delete READ[id];
  localStorage.setItem(LS_READ, JSON.stringify(READ));
}

function rowTemplate(r){
  const posted = fmtDate(r.postDate || r.importedAt);
  const checked = !!READ[r.id];
  return `<tr data-id="${esc(r.id)}">
    <td><input type="checkbox" ${checked?'checked':''} aria-label="read"></td>
    <td class="title"><a href="#" data-open="1"><strong>${esc(r.title||'(no title)')}</strong></a></td>
    <td>${esc(r.country||'')}</td>
    <td><span class="pill">${esc(r.source||'')}</span></td>
    <td class="snippet">${esc(r.summary||'')}</td>
    <td>${esc(posted)}</td>
  </tr>`;
}

function renderTable(rows){
  const $tbody=document.querySelector('#tbl tbody');
  $tbody.innerHTML = rows.map(rowTemplate).join('');
  document.getElementById("fallback").style.display = rows.length ? "none" : "block";
  document.getElementById("fallback").textContent = rows.length ? "" : "No casting jobs match your filters.";

  // handlers
  $tbody.querySelectorAll('input[type=checkbox]').forEach((box)=>{
    box.addEventListener('change', (e)=>{
      const id = e.target.closest('tr').dataset.id;
      toggleRead(id, e.target.checked);
    });
  });

  $tbody.querySelectorAll('a[data-open]').forEach((a)=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const id = e.target.closest('tr').dataset.id;
      const r = FILTERED.find(x=>x.id===id) || DATA.find(x=>x.id===id);
      renderPreview(r);
    });
  });
}

function mailtoHref(subject, body){
  return `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

function renderPreview(r){
  const $p = document.getElementById("preview");
  if (!r){ $p.innerHTML = `<div class="muted">Select a post to preview…</div>`; return; }
  const posted = fmtDate(r.postDate || r.importedAt);

  $p.innerHTML = `
    <h2>${esc(r.title||'(no title)')}</h2>
    <div class="meta">
      <span class="pill">${esc(r.country||'')}</span>
      <span class="pill">${esc(r.source||'')}</span>
      <span class="pill">Posted: ${esc(posted)}</span>
    </div>
    <div class="btns">
      <a class="btn" href="${esc(r.url)}" target="_blank" rel="noopener">View original</a>
      <a class="btn" href="${mailtoHref('Regarding your casting call on Facebook', MAIL_BODY)}">Email (mailto)</a>
      <button class="btn" id="copyMail">Copy email text</button>
      <button class="btn" id="markRead">${READ[r.id] ? 'Unmark' : 'Mark read'}</button>
    </div>
    <pre style="white-space:pre-wrap;margin:0">${esc(r.summary||'')}</pre>
  `;

  // copy + mark handlers
  document.getElementById('copyMail').onclick = ()=>{
    navigator.clipboard.writeText(MAIL_BODY);
  };
  document.getElementById('markRead').onclick = ()=>{
    const newState = !READ[r.id];
    toggleRead(r.id, newState);
    applyAndRender();
    renderPreview(r);
  };
}

// UI events
["q","source","age","sort","onlyUnread"].forEach(id=>{
  document.getElementById(id).addEventListener('input', applyAndRender);
});
</script>
</body>
</html>
