<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Selfcast – Casting Jobs Radar</title>
<meta name="robots" content="noindex,nofollow" />
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:20px;background:#0b0b0b;color:#f5f5f5}
  a{color:#4da3ff;text-decoration:none}
  .wrap{max-width:1200px;margin:0 auto}
  .top{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0;font-size:26px;font-weight:900}
  .btn{background:#1f1f1f;border:1px solid #2a2a2a;color:#fff;padding:8px 14px;border-radius:10px;text-decoration:none;font-weight:700}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 18px}
  input,select{padding:6px 8px;border:1px solid #222;background:#141414;color:#f5f5f5;border-radius:8px}
  table{width:100%;border-collapse:collapse;background:#141414;border-radius:10px;overflow:hidden;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid #222;vertical-align:top;text-align:left}
  tr:hover{background:#161616}
  .small{font-size:12px;color:#b3b3b3}
  .snippet{max-height:7.5em;overflow:hidden;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>Selfcast – Casting Jobs Radar</h1>
    <a class="btn" href="/radar/">← Back</a>
  </div>
  <div class="small" id="meta">Loading…</div>

  <div class="controls">
    <input id="q" type="search" placeholder="Search…" />
    <select id="source"><option value="">All sources</option></select>
    <select id="age"><option value="">Any time</option>
      <option value="1">Last 24h</option><option value="3">Last 3 days</option>
      <option value="7">Last 7 days</option><option value="14">Last 14 days</option>
      <option value="30">Last 30 days</option>
    </select>
  </div>

  <table id="tbl" style="display:none">
    <thead>
      <tr><th>✔</th><th>Title</th><th>Snippet</th><th>Source</th><th>Posted</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const CFG = { dataUrl: './live/jobs.json' };

const $q = document.getElementById('q');
const $source = document.getElementById('source');
const $age = document.getElementById('age');
const $tbl = document.getElementById('tbl');
const $tbody = document.querySelector('#tbl tbody');
const $meta = document.getElementById('meta');

// localStorage helpers
function getSeen() {
  return JSON.parse(localStorage.getItem("seenJobs")||"{}");
}
function setSeen(map) {
  localStorage.setItem("seenJobs", JSON.stringify(map));
}

const agoDays = (iso) => {
  if(!iso) return Infinity;
  const d = (Date.now() - new Date(iso).getTime())/86400000;
  return d;
};
const uniq = (arr) => [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b));

let DATA=[], seen=getSeen();

fetch(CFG.dataUrl,{cache:'no-store'}).then(r=>r.json()).then(rows=>{
  DATA = rows.items.sort((a,b)=> (b.posted_at||b.fetched_at||'').localeCompare(a.posted_at||a.fetched_at||''));
  $meta.textContent = `Loaded ${DATA.length.toLocaleString()} posts • Updated: ${rows.updatedAt}`;
  uniq(DATA.map(r=>r.source)).forEach(s=>{ const o=document.createElement('option'); o.value=s;o.textContent=s;$source.appendChild(o); });
  $tbl.style.display='table';
  render();
});

[q,$source,$age].forEach(el=>el.addEventListener('input',render));
[$source,$age].forEach(el=>el.addEventListener('change',render));

function matches(r){
  const q = $q.value.trim().toLowerCase();
  const so=$source.value, days=$age.value?parseInt($age.value,10):null;
  if (so && r.source !== so) return false;
  if (days!=null && agoDays(r.posted_at||r.fetched_at) > days) return false;
  if (!q) return true;
  const hay = [r.title,r.summary,r.source].join(' ').toLowerCase();
  return hay.includes(q);
}
function fmtDate(d){
  if(!d) return '';
  const dt=new Date(d);
  return dt.toLocaleDateString('da-DK');
}
function row(r){
  const checked = seen[r.url] ? "checked" : "";
  return `
  <tr>
    <td><input type="checkbox" data-url="${r.url}" ${checked}></td>
    <td><a href="${r.url}" target="_blank" rel="noopener"><strong>${r.title||'(no title)'}</strong></a></td>
    <td class="snippet">${r.summary||''}</td>
    <td>${r.source||''}</td>
    <td>${fmtDate(r.posted_at||r.fetched_at)}</td>
  </tr>`;
}
function render(){
  const rows = DATA.filter(matches).slice(0,2000);
  $tbody.innerHTML = rows.map(row).join('');
  document.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change',()=>{
      seen[cb.dataset.url]=cb.checked;
      setSeen(seen);
    });
  });
}
</script>
</body>
</html>
