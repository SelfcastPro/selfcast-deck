<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Selfcast – Casting Jobs Radar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:20px;background:#0b0b0b;color:#f5f5f5}
    a{color:#4da3ff;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto}
    h1{margin:0 0 10px;font-size:26px;font-weight:900}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 18px}
    input,select{padding:6px 10px;border:1px solid #222;background:#141414;color:#f5f5f5;border-radius:8px}
    table{width:100%;border-collapse:collapse;background:#141414;border-radius:12px;overflow:hidden;table-layout:fixed}
    th,td{padding:8px;border-bottom:1px solid #222;vertical-align:top;text-align:left;font-size:14px}
    tr:hover{background:#161616}
    th:nth-child(1),td:nth-child(1){width:32px;text-align:center}
    th:nth-child(2),td:nth-child(2){width:26%}
    th:nth-child(3),td:nth-child(3){width:10%}
    th:nth-child(4),td:nth-child(4){width:14%}
    th:nth-child(5),td:nth-child(5){width:38%}
    th:nth-child(6),td:nth-child(6){width:12%}
    .snippet{white-space:pre-wrap;max-height:7.2em;overflow:hidden}
    .small{font-size:12px;color:#b3b3b3}
    .fallback{padding:2rem;text-align:center;color:#aaa}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Selfcast – Casting Jobs Radar</h1>
  <div id="meta" class="small">Loading…</div>

  <div class="controls">
    <input id="q" type="search" placeholder="Search title, snippet, role, city…" />
    <select id="source"><option value="">All sources</option></select>
    <select id="age">
      <option value="">Any time</option>
      <option value="1">Last 24h</option>
      <option value="3">Last 3 days</option>
      <option value="7" selected>Last 7 days</option>
      <option value="14">Last 14 days</option>
      <option value="30">Last 30 days</option>
    </select>
    <label class="small"><input type="checkbox" id="onlyUnread"> Only unread</label>
  </div>

  <table id="tbl" style="display:none">
    <thead>
      <tr>
        <th>✓</th>
        <th>Title</th>
        <th>Country</th>
        <th>Source</th>
        <th>Snippet</th>
        <th>Posted</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="fallback" class="fallback" style="display:none"></div>
</div>

<script>
const PATH = "live/jobs.json";

const agoDays = (iso) => !iso ? Infinity : (Date.now() - new Date(iso).getTime())/86400000;
const esc = (s)=> (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":">","\"":"&quot;","'":"&#39;"}[m]));
const fmtDate = (d)=> d ? new Date(d).toLocaleDateString("da-DK") : "";

let DATA=[];
fetch(PATH,{cache:'no-store'})
  .then(r=>r.json())
  .then(json=>{
    DATA = (json.items || []).sort((a,b)=> new Date(b.posted_at||b.fetched_at) - new Date(a.posted_at||a.fetched_at));
    const updatedAt = json.updatedAt ? new Date(json.updatedAt).toLocaleString("da-DK") : "ukendt";

    if (!DATA.length) {
      document.getElementById("meta").style.display = "none";
      document.getElementById("tbl").style.display = "none";
      document.getElementById("fallback").style.display = "block";
      document.getElementById("fallback").textContent = `No casting jobs found — last update: ${updatedAt}`;
      return;
    }

    document.getElementById("meta").textContent = `Loaded ${DATA.length.toLocaleString()} posts · Updated: ${updatedAt}`;
    render();
  })
  .catch(err=>{
    document.getElementById("meta").textContent = "Error loading jobs: " + err.message;
  });

function matches(r){
  const days=parseInt(document.getElementById("age").value||"0",10);
  if (days && agoDays(r.posted_at||r.fetched_at) > days) return false;
  const q=document.getElementById("q").value.toLowerCase();
  if (q && !(r.title+" "+r.summary).toLowerCase().includes(q)) return false;
  const so=document.getElementById("source").value;
  if (so && r.source!==so) return false;
  return true;
}

function row(r){
  return `
  <tr>
    <td></td>
    <td><a href="${esc(r.url)}" target="_blank" rel="noopener"><strong>${esc(r.title||'(no title)')}</strong></a></td>
    <td>${esc(r.country||'')}</td>
    <td>${esc(r.source||'')}</td>
    <td class="snippet">${esc(r.summary||'')}</td>
    <td>${esc(fmtDate(r.posted_at||r.fetched_at))}</td>
  </tr>`;
}

function render(){
  const rows = DATA.filter(matches).slice(0,500);
  const $tbody=document.querySelector('#tbl tbody');
  $tbody.innerHTML = rows.map(row).join('');
  document.getElementById("tbl").style.display=rows.length?"table":"none";
}

document.getElementById("q").addEventListener("input",render);
document.getElementById("source").addEventListener("input",render);
document.getElementById("age").addEventListener("input",render);
document.getElementById("onlyUnread").addEventListener("input",render);
</script>
</body>
</html>
