<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Selfcast – Casting Jobs Radar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#0b0b0b;color:#f5f5f5;display:flex;height:100vh;overflow:hidden}
    a{color:#4da3ff;text-decoration:none}
    .wrap{flex:1;display:flex;flex-direction:column;padding:16px;max-width:1200px}
    h1{margin:0 0 10px;font-size:24px;font-weight:900}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:0 0 12px}
    input,select{padding:6px 10px;border:1px solid #222;background:#141414;color:#f5f5f5;border-radius:6px}
    table{width:100%;border-collapse:collapse;background:#141414;border-radius:8px;overflow:hidden;table-layout:fixed}
    th,td{padding:6px 8px;border-bottom:1px solid #222;vertical-align:top;text-align:left;font-size:13px}
    tr:hover{background:#161616;cursor:pointer}
    th:nth-child(1),td:nth-child(1){width:26px;text-align:center}
    th:nth-child(2),td:nth-child(2){width:26%}
    th:nth-child(3),td:nth-child(3){width:10%}
    th:nth-child(4),td:nth-child(4){width:14%}
    th:nth-child(5),td:nth-child(5){width:38%}
    th:nth-child(6),td:nth-child(6){width:12%}
    .snippet{white-space:pre-wrap;max-height:7.2em;overflow:hidden}
    .small{font-size:12px;color:#b3b3b3}
    .fallback{padding:2rem;text-align:center;color:#aaa}
    .layout{display:flex;flex:1;overflow:hidden;gap:12px}
    .left{flex:1;overflow:auto}
    .right{width:500px;overflow:auto;background:#111;padding:16px;border-left:1px solid #222}
    .right h2{margin-top:0;font-size:16px}
    button{background:#4da3ff;color:#fff;border:none;padding:6px 10px;margin:4px 4px 8px 0;border-radius:6px;cursor:pointer;font-size:13px}
    button:hover{background:#3486d8}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Selfcast – Casting Jobs Radar</h1>
  <div id="meta" class="small">Loading…</div>
  <div class="controls">
    <input id="q" type="search" placeholder="Search…"/>
    <select id="source"><option value="">All sources</option></select>
    <select id="age">
      <option value="">Any time</option>
      <option value="1">Last 24h</option>
      <option value="3">Last 3 days</option>
      <option value="7" selected>Last 7 days</option>
      <option value="14">Last 14 days</option>
      <option value="30">Last 30 days</option>
    </select>
    <select id="sort">
      <option value="new">Newest first</option>
      <option value="old">Oldest first</option>
    </select>
    <label class="small"><input type="checkbox" id="onlyUnread"> Only unread</label>
  </div>
  <div class="layout">
    <div class="left">
      <table id="tbl" style="display:none">
        <thead>
          <tr>
            <th>✓</th>
            <th>Title</th>
            <th>Country</th>
            <th>Source</th>
            <th>Snippet</th>
            <th>Posted</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="fallback" class="fallback" style="display:none"></div>
    </div>
    <div class="right" id="detail"><em>Select a post…</em></div>
  </div>
</div>

<script>
const PATH="live/jobs.json";
const agoDays=(iso)=>!iso?Infinity:(Date.now()-new Date(iso).getTime())/86400000;
const esc=(s)=> (s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&gt;":">","\"":"&quot;","'":"&#39;"}[m]));
const fmtDate=(d)=> d?new Date(d).toLocaleDateString("da-DK"):"";

let DATA=[],READ={};
if(localStorage.readPosts){try{READ=JSON.parse(localStorage.readPosts)}catch{}}

fetch(PATH,{cache:'no-store'})
  .then(r=>r.json())
  .then(json=>{
    DATA=json.items||[];
    const updatedAt=json.updatedAt?new Date(json.updatedAt).toLocaleString("da-DK"):"ukendt";
    if(!DATA.length){
      document.getElementById("meta").style.display="none";
      document.getElementById("tbl").style.display="none";
      document.getElementById("fallback").style.display="block";
      document.getElementById("fallback").textContent=`No casting jobs found — last update: ${updatedAt}`;
      return;
    }
    document.getElementById("meta").textContent=`Loaded ${DATA.length.toLocaleString()} posts · Updated: ${updatedAt} · live from Apify`;
    render();
  });

function matches(r){
  const q=document.getElementById("q").value.toLowerCase();
  const src=document.getElementById("source").value;
  const age=document.getElementById("age").value;
  const onlyUnread=document.getElementById("onlyUnread").checked;
  if(q && !(r.title.toLowerCase().includes(q)||r.summary.toLowerCase().includes(q))) return false;
  if(src && r.source!==src) return false;
  if(age && agoDays(r.posted_at||r.fetched_at)>+age) return false;
  if(onlyUnread && READ[r.url]) return false;
  return true;
}
function row(r){
  return `<tr onclick="showDetail('${esc(r.url)}')">
    <td><input type="checkbox" onchange="toggleRead('${esc(r.url)}')" ${READ[r.url]?"checked":""}></td>
    <td><strong>${esc(r.title||'(no title)')}</strong></td>
    <td>${esc(r.country||'')}</td>
    <td>${esc(r.source||'')}</td>
    <td class="snippet">${esc(r.summary||'').split("\n").slice(0,10).join("\n")}</td>
    <td>${esc(fmtDate(r.posted_at||r.fetched_at))}</td>
  </tr>`;
}
function render(){
  let rows=DATA.filter(matches);
  const sort=document.getElementById("sort").value;
  rows.sort((a,b)=>{
    const da=new Date(a.posted_at||a.fetched_at),db=new Date(b.posted_at||b.fetched_at);
    return sort==="old"?da-db:db-da;
  });
  const $tbody=document.querySelector('#tbl tbody');
  $tbody.innerHTML=rows.map(row).join('');
  document.getElementById("tbl").style.display=rows.length?"table":"none";
}
function toggleRead(id){
  READ[id]=!READ[id];
  if(!READ[id]) delete READ[id];
  localStorage.readPosts=JSON.stringify(READ);
}
function showDetail(id){
  const r=DATA.find(x=>x.url===id);
  if(!r) return;
  READ[id]=true;
  localStorage.readPosts=JSON.stringify(READ);
  document.getElementById("detail").innerHTML=`
    <div class="small">${esc(r.country||'')} · ${esc(r.source||'')} · ${fmtDate(r.posted_at||r.fetched_at)}</div>
    <h2>${esc(r.title||'(no title)')}</h2>
    <button onclick="window.open('${esc(r.url)}','_blank')">Open post</button>
    <button onclick="mailtoProducer('${esc(r.url)}')">Email producer</button>
    <pre>${esc(r.summary||'')}</pre>`;
}
function mailtoProducer(id){
  const subject="Regarding your casting call on Facebook";
  const body=`Hi,%0D%0A%0D%0AWe came across your casting post on Facebook and would love to help.%0D%0A...`;
  window.location=`mailto:?subject=${subject}&body=${body}`;
}
document.getElementById("q").addEventListener("input",render);
document.getElementById("source").addEventListener("change",render);
document.getElementById("age").addEventListener("change",render);
document.getElementById("sort").addEventListener("change",render);
document.getElementById("onlyUnread").addEventListener("change",render);
</script>
</body>
</html>
