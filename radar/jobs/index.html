<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Selfcast – Casting Jobs Radar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui,Roboto,Arial;margin:0;background:#0b0b0b;color:#f5f5f5}
    a{color:#4da3ff;text-decoration:none}
    .wrap{max-width:1400px;margin:0 auto;padding:20px}
    h1{margin:0 0 10px;font-size:26px;font-weight:900}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 18px}
    input,select{padding:6px 10px;border:1px solid #222;background:#141414;color:#f5f5f5;border-radius:8px}
    .layout{display:flex;gap:20px}
    .table-wrap{flex:2;overflow:auto}
    .detail{flex:1;background:#111;padding:15px;border-radius:8px;position:sticky;top:20px;height:85vh;overflow:auto}
    table{width:100%;border-collapse:collapse;background:#141414;border-radius:12px;overflow:hidden;table-layout:fixed}
    th,td{padding:8px;border-bottom:1px solid #222;vertical-align:top;text-align:left;font-size:14px}
    tr:hover{background:#161616;cursor:pointer}
    th:nth-child(1),td:nth-child(1){width:32px;text-align:center}
    th:nth-child(2),td:nth-child(2){width:26%}
    th:nth-child(3),td:nth-child(3){width:10%}
    th:nth-child(4),td:nth-child(4){width:14%}
    th:nth-child(5),td:nth-child(5){width:38%}
    th:nth-child(6),td:nth-child(6){width:12%}
    .snippet{white-space:pre-wrap;max-height:10em;overflow:hidden}
    .small{font-size:12px;color:#b3b3b3}
    .fallback{padding:2rem;text-align:center;color:#aaa}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Selfcast – Casting Jobs Radar</h1>
  <div id="meta" class="small">Loading…</div>

  <div class="controls">
    <input id="q" type="search" placeholder="Search…" />
    <select id="source"><option value="">All sources</option></select>
    <select id="sort">
      <option value="new">Newest first</option>
      <option value="old">Oldest first</option>
    </select>
    <label class="small"><input type="checkbox" id="onlyUnread"> Only unread</label>
  </div>

  <div class="layout">
    <div class="table-wrap">
      <table id="tbl" style="display:none">
        <thead>
          <tr>
            <th>✓</th><th>Title</th><th>Country</th><th>Source</th><th>Snippet</th><th>Posted</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="fallback" class="fallback" style="display:none"></div>
    </div>
    <div id="detail" class="detail">Select a job to view full details</div>
  </div>
</div>

<script>
const PATH = "live/jobs.json";
function loadSeen(){ try{return JSON.parse(localStorage.getItem("seenJobs")||"{}");}catch{return{}} }
function saveSeen(x){ localStorage.setItem("seenJobs",JSON.stringify(x)); }
let seen = loadSeen();

const esc = (s)=> (s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&gt;":">","\"":"&quot;","'":"&#39;"}[m]));
const fmtDate = (d)=> d ? new Date(d).toLocaleDateString("da-DK") : "";

function truncate(text, maxLines=10){
  const lines=text.split("\n");
  return lines.slice(0,maxLines).join("\n")+(lines.length>maxLines?" …":"");
}

let DATA=[];
fetch(PATH,{cache:'no-store'})
 .then(r=>r.json())
 .then(json=>{
   DATA = json.items||[];
   const updatedAt=json.updatedAt?new Date(json.updatedAt).toLocaleString("da-DK"):"ukendt";
   document.getElementById("meta").textContent=`Loaded ${DATA.length} posts · Updated: ${updatedAt}`;
   uniq(DATA.map(r=>r.source)).forEach(s=>{const o=document.createElement("option");o.value=s;o.textContent=s;source.appendChild(o);});
   render();
 });

function uniq(arr){return[...new Set(arr.filter(Boolean))];}
function makeKey(r){return(r.url||"")+"_"+(r.posted_at||r.fetched_at||"");}

function row(r){
  const key=makeKey(r);
  const checked=seen[key]?"checked":"";
  return `<tr data-id="${esc(key)}">
    <td><input type="checkbox" ${checked}></td>
    <td><strong>${esc(r.title||"(no title)")}</strong></td>
    <td>${esc(r.country||"")}</td>
    <td>${esc(r.source||"")}</td>
    <td class="snippet">${esc(truncate(r.summary||""))}</td>
    <td>${esc(fmtDate(r.posted_at))}</td>
  </tr>`;
}

function render(){
  const q=document.getElementById("q").value.toLowerCase();
  const so=document.getElementById("source").value;
  const sort=document.getElementById("sort").value;
  const onlyUnread=document.getElementById("onlyUnread").checked;

  let rows=DATA.filter(r=>{
    if(so && r.source!==so) return false;
    if(onlyUnread && seen[makeKey(r)]) return false;
    if(q && !`${r.title} ${r.summary}`.toLowerCase().includes(q)) return false;
    return true;
  });

  rows.sort((a,b)=>{
    if(sort==="old") return new Date(a.posted_at)-new Date(b.posted_at);
    return new Date(b.posted_at)-new Date(a.posted_at);
  });

  const $tbody=document.querySelector("#tbl tbody");
  $tbody.innerHTML=rows.map(row).join("");
  document.getElementById("tbl").style.display=rows.length?"table":"none";
  document.getElementById("fallback").style.display=rows.length?"none":"block";

  $tbody.querySelectorAll("tr").forEach(tr=>{
    const key=tr.dataset.id;
    tr.addEventListener("click",()=>{
      const r=DATA.find(x=>makeKey(x)===key);
      if(r) showDetail(r);
    });
    tr.querySelector("input").addEventListener("change",e=>{
      if(e.target.checked) seen[key]=true; else delete seen[key];
      saveSeen(seen);
    });
  });
}

function showDetail(r){
  document.getElementById("detail").innerHTML=`
    <h3>${esc(r.title||"")}</h3>
    <div class="small">${esc(r.country||"")} · ${esc(r.source||"")} · ${fmtDate(r.posted_at)}</div>
    <pre style="white-space:pre-wrap">${esc(r.summary||"")}</pre>
    <p><a href="${esc(r.url)}" target="_blank">View original post</a></p>`;
}

["q","source","sort","onlyUnread"].forEach(id=>document.getElementById(id).addEventListener("input",render));
</script>
</body>
</html>
