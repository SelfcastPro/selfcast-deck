<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Selfcast – Casting Jobs Radar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root {
      --bg: #0b0b0b;
      --panel: #141414;
      --line: #222;
      --text: #f5f5f5;
      --muted: #b3b3b3;
      --brand: #4da3ff;
      --shadow: 0 8px 28px rgba(0,0,0,.28);
    }
    * { box-sizing: border-box }
    body { margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial }
    a { color: var(--brand); text-decoration: none }

    .wrap { max-width: 1280px; margin: 22px auto; padding: 0 16px }
    h1 { margin:0 0 8px; font-size: 28px; font-weight: 900 }
    .meta { color: var(--muted); font-size: 12px; margin-bottom: 12px }

    .controls { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 14px }
    input[type="search"], select, label.chk {
      padding: 8px 10px; border:1px solid var(--line); background: var(--panel); color: var(--text); border-radius: 10px; font-size:14px
    }
    label.chk { display:flex; align-items:center; gap:6px; }

    .grid { display:grid; grid-template-columns: 1fr 360px; gap:16px; align-items:start }
    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr } }

    .table { background: var(--panel); border:1px solid var(--line); border-radius: 12px; overflow:hidden }
    table { width:100%; border-collapse: collapse; table-layout: fixed }
    th, td { padding: 10px 10px; border-bottom:1px solid var(--line); vertical-align: top; font-size: 14px; }
    thead th { position: sticky; top: 0; background: #151515; z-index: 2 }
    tr:hover { background:#161616 }

    th:nth-child(1), td:nth-child(1){ width: 30px; text-align: center }
    th:nth-child(2), td:nth-child(2){ width: 28% } /* Title */
    th:nth-child(3), td:nth-child(3){ width: 10% } /* Country */
    th:nth-child(4), td:nth-child(4){ width: 12% } /* Source */
    th:nth-child(5), td:nth-child(5){ width: auto } /* Snippet */
    th:nth-child(6), td:nth-child(6){ width: 12% } /* Posted */

    .title a { font-weight: 800 }
    .src { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100% }
    .snippet {
      white-space: pre-wrap;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 10;   /* maks 10 linjer */
      line-clamp: 10;
      -webkit-box-orient: vertical;
    }
    .muted { color: var(--muted); font-size: 12px }
    .empty { padding: 2rem; text-align: center; color: var(--muted) }

    .detail {
      position: sticky; top: 12px;
      background: var(--panel); border:1px solid var(--line); border-radius: 12px; padding: 14px;
      box-shadow: var(--shadow); max-height: calc(100vh - 24px); overflow: auto;
    }
    .d-title { font-weight: 900; font-size: 18px; margin: 0 0 6px }
    .d-sub { font-size: 12px; color: var(--muted); margin-bottom: 10px }
    .d-body { white-space: pre-wrap; font-size: 14px; line-height: 1.4 }
    .row-actions { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 12px }
    .btn {
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border:1px solid var(--line); background:#1a1a1a; color:var(--text);
      border-radius:10px; font-size:14px; cursor:pointer; text-decoration:none;
    }
    .btn:hover { background:#1c1c1c }
    .right-link { font-size: 13px }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Selfcast – Casting Jobs Radar</h1>
  <div id="meta" class="meta">Loading…</div>

  <div class="controls">
    <input id="q" type="search" placeholder="Search…" />
    <select id="source"><option value="">All sources</option></select>
    <select id="sort">
      <option value="new">Newest first</option>
      <option value="old">Oldest first</option>
    </select>
    <label class="chk"><input type="checkbox" id="onlyUnread"> Only unread</label>
  </div>

  <div class="grid">
    <div class="table">
      <table id="tbl">
        <thead>
          <tr>
            <th>✓</th>
            <th>Title</th>
            <th>Country</th>
            <th>Source</th>
            <th>Snippet</th>
            <th>Posted</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="empty" class="empty" style="display:none"></div>
    </div>

    <aside class="detail" id="detail">
      <div class="muted">Select a row to preview…</div>
    </aside>
  </div>
</div>

<script>
const PATH = "live/jobs.json";

const $meta = document.getElementById("meta");
const $tbody = document.querySelector("#tbl tbody");
const $empty = document.getElementById("empty");
const $detail = document.getElementById("detail");

const $q = document.getElementById("q");
const $source = document.getElementById("source");
const $sort = document.getElementById("sort");
const $onlyUnread = document.getElementById("onlyUnread");

const agoDays = (iso) => (!iso ? Infinity : (Date.now() - new Date(iso).getTime())/86400000);
const fmtDate = (d)=> d ? new Date(d).toLocaleDateString("da-DK") : "";

let DATA = [];
let READ = new Set(JSON.parse(localStorage.getItem("jobs_read") || "[]"));

function saveRead(){ localStorage.setItem("jobs_read", JSON.stringify([...READ])); }
function keyFor(r){ return r.url || r.id || (r.title+"|"+(r.posted_at||"")).toLowerCase(); }

function emailBodyTemplate(r){
  const subject = "Regarding your casting call on Facebook";
  const body = [
"Hi",
"",
"We came across your casting post on Facebook and would love to help.",
"Please share more details about the role(s) and production so we can present the right candidates for you.",
"",
"The more info we can give the talents, the better the match:",
"- Client name",
"- Role description (gender, age, look, special requirements, photos/videos)",
"- Rights (e.g. 1 year worldwide, all platforms)",
"- Salary (total fee incl. buyout)",
"- Travel expenses (covered? up to 500 EUR?)",
"- Date(s) (specific day or period)",
"- Location (country, city/region)",
"",
"Next time you need talents, you can also book directly through the Selfcast platform.",
"We currently represent over 60,000 talents in 160+ countries, with a strong base across Europe.",
"",
"Best regards,",
"The Selfcast Team",
"CASTING MADE EASY",
"",
"—",
(r.title || "").trim(),
(r.url || "")
  ].join("\n");

  const href = "mailto:" +
    "?subject=" + encodeURIComponent(subject) +
    "&body=" + encodeURIComponent(body);

  return href;
}

function renderDetail(r){
  if (!r) {
    $detail.innerHTML = `<div class="muted">Select a row to preview…</div>`;
    return;
  }
  const meta = [
    r.country || "",
    r.source || "",
    fmtDate(r.posted_at || r.fetched_at)
  ].filter(Boolean).join(" · ");

  const mailHref = emailBodyTemplate(r);
  const original = r.url ? `<a class="right-link" href="${r.url}" target="_blank" rel="noopener">View original post</a>` : "";

  $detail.innerHTML = `
    <div class="d-sub">${meta}</div>
    <h3 class="d-title">${(r.title||"(no title)")}</h3>

    <div class="row-actions">
      <a class="btn" href="${mailHref}">✉️ Email producer</a>
      ${original ? `<span class="btn"><a class="right-link" href="${r.url}" target="_blank" rel="noopener">Open post ↗</a></span>` : ""}
    </div>

    <div class="d-body">${(r.summary||"").replace(/</g,"&lt;")}</div>
  `;
}

function rowHTML(r){
  const id = keyFor(r);
  const checked = READ.has(id) ? "checked" : "";
  const src = (r.source || "").replace("FacebookGroups","FacebookGroups");
  return `
    <tr data-id="${id}">
      <td><input type="checkbox" class="mark" ${checked}></td>
      <td class="title"><a href="${r.url || '#'}" target="_blank" rel="noopener">${(r.title||"(no title)")}</a></td>
      <td>${r.country||""}</td>
      <td class="src">${src}</td>
      <td class="snippet">${(r.summary||"").replace(/</g,"&lt;")}</td>
      <td>${fmtDate(r.posted_at||r.fetched_at)}</td>
    </tr>
  `;
}

function applyFilters(){
  const q = ($q.value||"").toLowerCase();
  const src = $source.value || "";
  const onlyUnread = $onlyUnread.checked;

  let rows = DATA.slice();

  if (q) {
    rows = rows.filter(r =>
      (r.title||"").toLowerCase().includes(q) ||
      (r.summary||"").toLowerCase().includes(q)
    );
  }
  if (src) rows = rows.filter(r => (r.source||"") === src);
  if (onlyUnread) rows = rows.filter(r => !READ.has(keyFor(r)));

  if ($sort.value === "old") {
    rows.sort((a,b)=> new Date(a.posted_at||a.fetched_at) - new Date(b.posted_at||b.fetched_at));
  } else {
    rows.sort((a,b)=> new Date(b.posted_at||b.fetched_at) - new Date(a.posted_at||a.fetched_at));
  }

  return rows;
}

function renderTable(selectFirst=true){
  const rows = applyFilters();
  if (!rows.length) {
    $tbody.innerHTML = "";
    $empty.style.display = "block";
    $empty.textContent = "No casting jobs match your filters.";
    renderDetail(null);
    return;
  }
  $empty.style.display = "none";
  $tbody.innerHTML = rows.map(rowHTML).join("");

  // vælg første række til preview
  if (selectFirst) {
    const first = rows[0];
    renderDetail(first);
  }
}

function attachEvents(){
  $tbody.addEventListener("click", (ev)=>{
    const tr = ev.target.closest("tr");
    if (!tr) return;

    // checkbox toggle
    if (ev.target.classList.contains("mark")) {
      const id = tr.dataset.id;
      if (ev.target.checked) READ.add(id); else READ.delete(id);
      saveRead();
      return;
    }

    // klik på række = vis i højre panel
    const id = tr.dataset.id;
    const r = DATA.find(x => keyFor(x) === id);
    renderDetail(r);
  });

  [$q, $source, $sort, $onlyUnread].forEach(el=>{
    el.addEventListener("input", ()=>renderTable(false));
    el.addEventListener("change", ()=>renderTable(false));
  });
}

fetch(PATH, { cache:"no-store" })
  .then(r=>r.json())
  .then(json=>{
    DATA = json.items || [];
    const updatedAt = json.updatedAt ? new Date(json.updatedAt).toLocaleString("da-DK") : "ukendt";
    $meta.textContent = `Loaded ${DATA.length.toLocaleString()} posts · Updated: ${updatedAt} · live from Apify`;

    // udfyld source-filter
    const uniq = [...new Set(DATA.map(x => x.source).filter(Boolean))];
    $source.innerHTML = `<option value="">All sources</option>` + uniq.map(s=>`<option>${s}</option>`).join("");

    attachEvents();
    renderTable(true);
  })
  .catch(err=>{
    $meta.textContent = "Error loading jobs: " + err.message;
    $empty.style.display = "block";
    $empty.textContent = "Could not load jobs.json";
  });
</script>
</body>
</html>
