<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Selfcast – Casting Jobs Radar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:20px;background:#0b0b0b;color:#f5f5f5}
    a{color:#4da3ff;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto}
    h1{margin:0 0 10px;font-size:26px;font-weight:900}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 18px}
    input,select{padding:6px 10px;border:1px solid #222;background:#141414;color:#f5f5f5;border-radius:8px}
    table{width:100%;border-collapse:collapse;background:#141414;border-radius:12px;overflow:hidden;table-layout:fixed}
    th,td{padding:8px;border-bottom:1px solid #222;vertical-align:top;text-align:left;font-size:14px}
    tr:hover{background:#161616}
    th:nth-child(1),td:nth-child(1){width:26%}    /* Title */
    th:nth-child(2),td:nth-child(2){width:10%}    /* Country */
    th:nth-child(3),td:nth-child(3){width:14%}    /* Source */
    th:nth-child(4),td:nth-child(4){width:38%}    /* Snippet */
    th:nth-child(5),td:nth-child(5){width:12%}    /* Posted */
    .snippet{white-space:pre-wrap;max-height:8.8em;overflow:hidden}
    .small{font-size:12px;color:#b3b3b3}
    .fallback{padding:2rem;text-align:center;color:#aaa}
    .fresh{box-shadow: inset 0 0 0 9999px rgba(35,145,70,.08)}
    /* Debug drawer (smalt og responsivt) */
    #debugPanel {
      position: fixed; top: 0; right: -440px; width: min(420px, 90vw); height: 100%;
      background: #111; color: #f5f5f5; border-left: 2px solid #333; overflow: auto;
      transition: right .25s ease; padding: 12px; z-index: 1000;
    }
    #debugPanel.open{ right: 0; }
    #debugPanel pre{ font-size:12px; white-space:pre-wrap; word-break:break-word; }
    #closeDebug{ padding:6px 10px; background:#333; border:none; border-radius:8px; color:#fff; cursor:pointer }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Selfcast – Casting Jobs Radar</h1>
  <div id="meta" class="small">Loading…</div>

  <div class="controls">
    <input id="q" type="search" placeholder="Search title, snippet, role, city…" />
    <select id="source"><option value="">All sources</option></select>
    <select id="age">
      <option value="">Any time</option>
      <option value="1">Last 24h</option>
      <option value="3">Last 3 days</option>
      <option value="7" selected>Last 7 days</option>
      <option value="14">Last 14 days</option>
      <option value="30">Last 30 days</option>
    </select>
    <label class="small"><input type="checkbox" id="onlyUnread"> Only unread</label>
  </div>

  <table id="tbl" style="display:none">
    <thead>
      <tr>
        <th>Title</th>
        <th>Country</th>
        <th>Source</th>
        <th>Snippet</th>
        <th>Posted</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="fallback" class="fallback" style="display:none"></div>
</div>

<!-- Debug drawer -->
<div id="debugPanel">
  <button id="closeDebug">Close</button>
  <h3>Debug view</h3>
  <pre id="debugContent">No item selected.</pre>
</div>

<script>
const PATH = "live/jobs.json";
// Brug samme dataset som crawleren – så siden kan vise opslag selv hvis jobs.json er tom.
const APIFY_FALLBACK_URL =
  "https://api.apify.com/v2/datasets/l3YKdBneIPN0q9YsI/items?format=json&clean=true";

const esc = (s)=> (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":">","\"":"&quot;","'":"&#39;"}[m]));
const fmtDate = (d)=> d ? new Date(d).toLocaleDateString("da-DK") : "";
const agoDays = (iso) => !iso ? Infinity : (Date.now() - new Date(iso).getTime())/86400000;
const uniq = (arr) => [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b));

// “set” til læst/ulæst
function loadSeen(){ try{return JSON.parse(localStorage.getItem("seenJobs")||"{}");}catch{return{}} }
function saveSeen(x){ localStorage.setItem("seenJobs",JSON.stringify(x)); }
let SEEN = loadSeen();

let DATA=[]; let UPDATED="";

// Loader fra jobs.json; hvis tom → fallback til Apify
bootstrap();
async function bootstrap(){
  try{
    const r = await fetch(PATH,{cache:'no-store'});
    if(!r.ok) throw new Error("HTTP "+r.status);
    const j = await r.json();
    const items = Array.isArray(j) ? j : (j.items||[]);
    UPDATED = j.updatedAt || "";
    if(items.length){
      DATA = items;
      afterLoad();
      return;
    }
    // Fallback – hent direkte fra Apify
    await loadFromApify();
  }catch(e){
    // også fallback ved fejl
    await loadFromApify();
  }
}

async function loadFromApify(){
  try{
    const r = await fetch(APIFY_FALLBACK_URL,{cache:'no-store'});
    if(!r.ok) throw new Error("HTTP "+r.status);
    const rows = await r.json();
    const toISO = (v)=>{
      if(!v) return null;
      if(typeof v==="number") { const d=new Date(v); return isNaN(d)?null:d.toISOString(); }
      if(/^\d+$/.test(String(v))) { const d=new Date(Number(v)); return isNaN(d)?null:d.toISOString(); }
      const d=new Date(String(v)); return isNaN(d)?null:d.toISOString();
    };
    const pickLink = (r)=>{
      let link = r.permalink || r.postUrl || r.url || r.shareUrl || r.facebookUrl || null;
      if(link && !String(link).startsWith("http")) link = "https://www.facebook.com"+link;
      return link;
    };
    DATA = rows.map(r=>{
      const text = r.text || r.postText || "";
      return {
        url: pickLink(r) || "#",
        title: text.slice(0, 80) + (text.length>80?"…":""),
        summary: text,
        country: "EU",
        source: "FacebookGroups",
        posted_at: toISO(r.timestamp) || toISO(r.date) || toISO(r.createdAt) || toISO(r.lastActivityTime),
        fetched_at: new Date().toISOString(),
        _raw: r
      };
    });
    UPDATED = new Date().toISOString();
    afterLoad(true);
  }catch(err){
    document.getElementById("meta").textContent = "Error loading jobs: "+err.message;
  }
}

function afterLoad(fromApify=false){
  DATA.sort((a,b)=> (b.posted_at||b.fetched_at||"").localeCompare(a.posted_at||a.fetched_at||""));
  document.getElementById("meta").textContent =
    `Loaded ${DATA.length.toLocaleString()} posts · Updated: ${UPDATED ? new Date(UPDATED).toLocaleString("da-DK") : "ukendt"}${fromApify?" · live from Apify":""}`;

  // byg filtreringsværdier
  const $source = document.getElementById("source");
  uniq(DATA.map(r=>r.source)).forEach(s=>{ const o=document.createElement('option'); o.value=s;o.textContent=s;$source.appendChild(o); });

  document.getElementById("tbl").style.display='table';
  render();
}

// UI
const $q = document.getElementById('q');
const $source = document.getElementById('source');
const $age = document.getElementById('age');
const $onlyUnread = document.getElementById('onlyUnread');
[$q,$source,$age,$onlyUnread].forEach(el=>el.addEventListener('input', render));

function keyOf(r){ return (r.url||"") + "_" + (r.posted_at||r.fetched_at||""); }

function matches(r){
  const q = ($q.value||"").trim().toLowerCase();
  const so = $source.value;
  const days = $age.value ? parseInt($age.value,10) : null;
  if (so && r.source !== so) return false;
  if (days!=null && agoDays(r.posted_at||r.fetched_at) > days) return false;
  if ($onlyUnread.checked && SEEN[keyOf(r)]) return false;
  if (!q) return true;
  return [r.title,r.summary,r.country,r.source].join(" ").toLowerCase().includes(q);
}

function render(){
  const rows = DATA.filter(matches).slice(0,1000);
  const $tbody=document.querySelector('#tbl tbody');
  $tbody.innerHTML = rows.map((r,i)=>row(r,i)).join('');
  // bind
  document.querySelectorAll('.dbg').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const idx = Number(a.dataset.i);
      openDebug(DATA[idx]._raw || DATA[idx]);
    });
  });
  document.querySelectorAll('.mark-read').forEach(cb=>{
    cb.addEventListener('change',()=>{
      const idx = Number(cb.dataset.i);
      const k = keyOf(DATA[idx]);
      if(cb.checked) SEEN[k]=true; else delete SEEN[k];
      saveSeen(SEEN);
    });
  });
}

function row(r,i){
  const d = r.posted_at || r.fetched_at;
  const fresh = agoDays(d) <= 7 ? " fresh" : "";
  const checked = SEEN[keyOf(r)] ? "checked" : "";
  return `
  <tr class="${fresh}">
    <td>
      <a href="#" class="dbg" data-i="${i}"><strong>${esc(r.title||'(no title)')}</strong></a>
      <div class="small"><a href="${esc(r.url)}" target="_blank" rel="noopener">View Post</a> ·
        <label><input type="checkbox" class="mark-read" data-i="${i}" ${checked}/> read</label>
      </div>
    </td>
    <td>${esc(r.country||'')}</td>
    <td>${esc(r.source||'')}</td>
    <td class="snippet">${esc(r.summary||'')}</td>
    <td>${esc(fmtDate(d))}</td>
  </tr>`;
}

// Debug drawer
function openDebug(obj){
  const panel = document.getElementById("debugPanel");
  const pre = document.getElementById("debugContent");
  pre.textContent = JSON.stringify(obj, null, 2);
  panel.classList.add("open");
}
document.getElementById("closeDebug").addEventListener("click", ()=>{
  document.getElementById("debugPanel").classList.remove("open");
});
</script>
</body>
</html>
