<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Selfcast – Casting Jobs Radar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body {font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#0b0b0b;color:#f5f5f5;display:flex;min-height:100vh}
    a {color:#4da3ff;text-decoration:none}
    h1 {margin:0 0 10px;font-size:26px;font-weight:900}
    .wrap {flex:1;max-width:900px;padding:20px}
    .controls {display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 18px}
    input,select {padding:6px 10px;border:1px solid #222;background:#141414;color:#f5f5f5;border-radius:8px}
    table {width:100%;border-collapse:collapse;background:#141414;border-radius:12px;overflow:hidden;table-layout:fixed}
    th,td {padding:8px;border-bottom:1px solid #222;vertical-align:top;text-align:left;font-size:14px}
    tr:hover {background:#161616;cursor:pointer}
    th:nth-child(1),td:nth-child(1){width:32px;text-align:center}
    th:nth-child(2),td:nth-child(2){width:26%}
    th:nth-child(3),td:nth-child(3){width:10%}
    th:nth-child(4),td:nth-child(4){width:14%}
    th:nth-child(5),td:nth-child(5){width:38%}
    th:nth-child(6),td:nth-child(6){width:12%}
    .snippet{white-space:pre-wrap;max-height:7.2em;overflow:hidden}
    .small{font-size:12px;color:#b3b3b3}
    .fallback{padding:2rem;text-align:center;color:#aaa}
    .preview {width:35%;max-width:480px;border-left:1px solid #222;background:#111;padding:20px;overflow-y:auto}
    .hidden {display:none}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Selfcast – Casting Jobs Radar</h1>
  <div id="meta" class="small">Loading…</div>

  <div class="controls">
    <input id="q" type="search" placeholder="Search title, snippet, role, city…" />
    <select id="source"><option value="">All sources</option></select>
    <select id="sort">
      <option value="newest" selected>Newest first</option>
      <option value="oldest">Oldest first</option>
    </select>
    <label class="small"><input type="checkbox" id="onlyUnread"> Only unread</label>
  </div>

  <table id="tbl" style="display:none">
    <thead>
      <tr>
        <th>✓</th>
        <th>Title</th>
        <th>Country</th>
        <th>Source</th>
        <th>Snippet</th>
        <th>Posted</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="fallback" class="fallback" style="display:none"></div>
</div>

<div id="preview" class="preview hidden">
  <h2 id="pv-title"></h2>
  <div id="pv-meta" class="small"></div>
  <pre id="pv-text" style="white-space:pre-wrap"></pre>
  <p><a id="pv-link" href="#" target="_blank">View original post</a></p>
</div>

<script>
const PATH = "live/jobs.json";

// helpers
const esc = (s)=> (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":">","\"":"&quot;","'":"&#39;"}[m]));
const fmtDate = (d)=> d ? new Date(d).toLocaleDateString("da-DK") : "";
function loadSeen(){ try{return JSON.parse(localStorage.getItem("seenJobs")||"{}");}catch{return{}} }
function saveSeen(x){ localStorage.setItem("seenJobs",JSON.stringify(x)); }
let seen = loadSeen();

// lav mailto links i teksten
function makeMailtoLinks(text) {
  if (!text) return "";
  const emailRegex = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g;
  return text.replace(emailRegex, (email) => {
    const subject = "Regarding your casting call on Facebook";
    const body = `Hi,

We came across your casting post on Facebook and would love to help.
Please share more details about the role(s) and production so we can present the right candidates for you.

The more info we can give the talents, the better the match:
- Client name
- Role description (gender, age, look, special requirements, photos/videos)
- Rights (e.g. 1 year worldwide, all platforms)
- Salary (total fee incl. buyout)
- Travel expenses (covered? up to 500 EUR?)
- Date(s) (specific day or period)
- Location (country, city/region)

Next time you need talents, you can also book directly through the Selfcast platform.
We currently represent over 60,000 talents in 160+ countries, with a strong base across Europe.

Best regards,
The Selfcast Team
CASTING MADE EASY`;

    return `<a href="mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}">${email}</a>`;
  });
}

let DATA=[];
fetch(PATH,{cache:'no-store'})
  .then(r=>r.json())
  .then(json=>{
    DATA = json.items || [];
    const updatedAt = json.updatedAt ? new Date(json.updatedAt).toLocaleString("da-DK") : "ukendt";
    if (!DATA.length) {
      document.getElementById("meta").style.display = "none";
      document.getElementById("tbl").style.display = "none";
      document.getElementById("fallback").style.display = "block";
      document.getElementById("fallback").textContent = `No casting jobs found — last update: ${updatedAt}`;
      return;
    }
    document.getElementById("meta").textContent = `Loaded ${DATA.length.toLocaleString()} posts · Updated: ${updatedAt}`;
    const uniq = arr => [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    uniq(DATA.map(r=>r.source)).forEach(s=>{ const o=document.createElement('option'); o.value=s;o.textContent=s;document.getElementById("source").appendChild(o); });
    document.getElementById("tbl").style.display='table';
    render();
  })
  .catch(err=>{
    document.getElementById("meta").textContent = "Error loading jobs: " + err.message;
  });

// UI state
const $q=document.getElementById('q'),
      $source=document.getElementById('source'),
      $sort=document.getElementById('sort'),
      $onlyUnread=document.getElementById('onlyUnread');
[$q,$source,$sort,$onlyUnread].forEach(el=>el.addEventListener('input',render));

function makeKey(r){ return (r.url||"") + "_" + (r.posted_at||r.fetched_at||""); }

function matches(r){
  if ($source.value && r.source !== $source.value) return false;
  if ($onlyUnread.checked && seen[makeKey(r)]) return false;
  const q=$q.value.trim().toLowerCase();
  if (!q) return true;
  return [r.title,r.summary,r.country,r.source].join(' ').toLowerCase().includes(q);
}

function row(r){
  const key = makeKey(r);
  const checked = seen[key] ? "checked" : "";
  const date = r.posted_at || r.fetched_at;
  return `
  <tr data-id="${esc(key)}">
    <td><input type="checkbox" ${checked}></td>
    <td><strong>${esc(r.title||'(no title)')}</strong></td>
    <td>${esc(r.country||'')}</td>
    <td>${esc(r.source||'')}</td>
    <td class="snippet">${makeMailtoLinks(r.summary||'')}</td>
    <td>${esc(fmtDate(date))}</td>
  </tr>`;
}

function render(){
  let rows = DATA.filter(matches);
  if ($sort.value==="newest") rows.sort((a,b)=> (b.posted_at||b.fetched_at||"").localeCompare(a.posted_at||a.fetched_at||""));
  else rows.sort((a,b)=> (a.posted_at||a.fetched_at||"").localeCompare(b.posted_at||b.fetched_at||""));

  const $tbody=document.querySelector('#tbl tbody');
  $tbody.innerHTML = rows.map(row).join('');

  $tbody.querySelectorAll('tr').forEach(tr=>{
    const id=tr.dataset.id;
    const cb=tr.querySelector('input[type=checkbox]');
    cb.addEventListener('change',()=>{
      if(cb.checked) seen[id]=true; else delete seen[id];
      saveSeen(seen);
    });
    tr.addEventListener('click',e=>{
      if(e.target.tagName==="INPUT" || e.target.tagName==="A") return;
      const r=DATA.find(x=>makeKey(x)===id);
      if (!r) return;
      document.getElementById("pv-title").textContent = r.title||"(no title)";
      document.getElementById("pv-meta").textContent = `${r.country||''} · ${r.source||''} · ${fmtDate(r.posted_at||r.fetched_at)}`;
      document.getElementById("pv-text").innerHTML = makeMailtoLinks(r.summary||'');
      document.getElementById("pv-link").href = r.url||"#";
      document.getElementById("preview").classList.remove("hidden");
    });
  });
}
</script>
</body>
</html>
