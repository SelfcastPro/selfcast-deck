// scripts/fix-links.mjs
// Engangsscript — opdaterer jobs.json så links peger på opslag, ikke kun gruppe

import fs from "node:fs/promises";

const FILE = "radar/jobs/live/jobs.json";

async function run() {
  const raw = await fs.readFile(FILE, "utf8");
  const data = JSON.parse(raw);

  let fixed = 0;
  for (const item of data.items) {
    // Hvis link bare er til en gruppe-URL og vi har et id, byg et post-link
    const groupMatch = item.url.match(/groups\/(\d+)/);
    if (groupMatch && item.summary && !item.url.includes("/posts/") && item.summary.length > 0) {
      const postIdMatch = item.summary.match(/"id":\s*"(\d+)"/); // fallback hvis id sidder i teksten
      if (item.id) {
        item.url = `https://www.facebook.com/groups/${groupMatch[1]}/posts/${item.id}`;
        fixed++;
      } else if (postIdMatch) {
        item.url = `https://www.facebook.com/groups/${groupMatch[1]}/posts/${postIdMatch[1]}`;
        fixed++;
      }
    }
  }

  await fs.writeFile(FILE, JSON.stringify(data, null, 2), "utf8");
  console.log(`✔ Fixed ${fixed} links in ${FILE}`);
}

run().catch(err => {
  console.error(err);
  process.exit(1);
});
