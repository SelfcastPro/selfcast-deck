<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Selfcast – Talent Presentation (Role Picker)</title>
<style>
  :root{--bg:#0b0b0b;--fg:#f5f5f5;--muted:#b7b7b7;--accent:#e51c23;--card:#141414;--line:#222}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:inherit}
  .app{display:grid;grid-template-rows:auto 1fr;min-height:100%}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line);background:#0d0d0d}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:28px;height:28px;border-radius:8px;background:var(--accent);display:grid;place-items:center;font-weight:900}
  .title{font-weight:800;letter-spacing:.2px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:#1f1f1f;border:1px solid #2a2a2a;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;text-decoration:none}
  .btn.accent{background:var(--accent);border-color:#bf141b}
  .btn.ghost{background:transparent}
  .pane{display:grid;grid-template-columns:380px 320px 1fr;min-height:0}
  .col{border-right:1px solid var(--line);padding:14px;overflow:auto}
  .col:last-child{border-right:none}
  .field{display:grid;gap:6px;margin-bottom:12px}
  label{font-size:12px;color:var(--muted)}
  input,textarea,select{width:100%;background:var(--card);border:1px solid var(--line);color:#fff;border-radius:10px;padding:10px 12px}
  textarea{min-height:100px;resize:vertical}
  .hint{font-size:12px;color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
  .chip{font-size:12px;border:1px solid #2a2a2a;border-radius:999px;padding:4px 8px;color:var(--muted)}
  .list{display:grid;gap:6px}
  .rowPick{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;background:#121212;border:1px solid #222;border-radius:10px;padding:8px}
  .rowPick img{width:48px;height:48px;object-fit:cover;border-radius:8px;background:#0b0b0b}
  .tag{font-size:11px;border:1px solid #2a2a2a;border-radius:999px;padding:2px 6px;color:var(--muted)}
  .slides{height:100%;display:grid;place-items:center}
  .slide{width:100%;height:100%;display:none}
  .slide.active{display:block}
  .deck{width:100%;height:100%;display:grid;place-items:center}
  .frame{width:min(1024px,92vw);height:min(576px,72vh);background:#101010;border:1px solid #242424;border-radius:20px;box-shadow:0 30px 60px rgba(0,0,0,.35);position:relative;overflow:hidden}
  .frame .inner{position:absolute;inset:0;padding:22px}
  .cover .title{font-size:36px;font-weight:900}
  .cover .subtitle{margin-top:6px;color:var(--muted)}
  .cover .meta{position:absolute;bottom:22px;left:22px;font-size:13px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:8px}
  .grid .card{background:#121212;border:1px solid #222;border-radius:14px;display:grid;grid-template-rows:140px auto}
  .card img{width:100%;height:140px;object-fit:cover;border-top-left-radius:14px;border-top-right-radius:14px;background:#0b0b0b}
  .card .info{padding:10px 12px}
  .card .info .name{font-weight:700}
  .talent{display:grid;grid-template-columns:58% 42%;gap:18px;align-items:stretch}
  .hero{background:#101010;border:1px solid #222;border-radius:16px;overflow:hidden;display:grid}
  .hero img{width:100%;height:100%;object-fit:cover}
  .facts{display:grid;gap:10px}
  .facts .box{background:#101010;border:1px solid #222;border-radius:16px;padding:14px}
  .facts .kvs{display:grid;grid-template-columns:auto 1fr;gap:6px 12px}
  .facts .k{color:var(--muted)}
  .links a{display:inline-block;margin-right:8px;margin-bottom:6px;background:#161616;border:1px solid #2a2a2a;border-radius:999px;padding:6px 10px;font-size:12px;text-decoration:none}
  .pick{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .pick .thumb{position:relative;border-radius:12px;overflow:hidden;border:1px solid #222}
  .pick img{width:100%;height:110px;object-fit:cover;display:block}
  .pick input{position:absolute;top:6px;left:6px}
  .badge{display:inline-block;border:1px solid #2a2a2a;border-radius:999px;padding:2px 8px;font-size:12px;color:var(--muted)}
  .nav{position:absolute;inset:auto 16px 16px 16px;display:flex;justify-content:space-between;pointer-events:none}
  .nav .btn{pointer-events:auto}
  .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111;border:1px solid #2a2a2a;padding:10px 14px;border-radius:10px;color:var(--muted);display:none}
  .toast.show{display:block}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <a class="btn ghost" href="/" style="margin-right:8px">← Home</a>
      <div class="logo">S</div>
      <div class="title">Talent Presentation</div>
    </div>
    <div class="toolbar">
      <button class="btn ghost" id="btnPrev">← Prev</button>
      <button class="btn ghost" id="btnNext">Next →</button>
      <button class="btn" id="btnPrint">Export PDF</button>
      <button class="btn accent" id="btnGenerate">Generate</button>
    </div>
  </header>

  <div class="pane">
    <!-- COL 1: Role input & filters -->
    <aside class="col">
      <div class="field">
        <label>Deck Title</label>
        <input id="inpTitle" value="Casting Presentation"/>
      </div>

      <div class="field">
        <label>Paste 1 role URL (or roleId)</label>
        <textarea id="inpRole" placeholder="https://producer.selfcast.com/production/.../role/...\neller kun roleId"></textarea>
        <div class="hint">Loader listen (op til 50+) for dén rolle.</div>
      </div>

      <div class="field">
        <label>Statuses to include</label>
        <div class="chips">
          <label class="chip"><input type="checkbox" class="st" value="OPTION"> Option</label>
          <label class="chip"><input type="checkbox" class="st" value="IN_REVIEW" checked> In review</label>
          <label class="chip"><input type="checkbox" class="st" value="SHORTLISTED"> Shortlisted</label>
          <label class="chip"><input type="checkbox" class="st" value="IN_DIALOG"> In dialog</label>
          <label class="chip"><input type="checkbox" class="st" value="BOOKED"> Booked</label>
        </div>
      </div>

      <div class="field">
        <label>Hide talents with fewer than N images</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="minImages" type="number" value="1" min="0" max="9" style="width:80px"/>
          <span class="hint">(best_image + gallery)</span>
        </div>
      </div>

      <div class="field" style="display:flex;gap:8px">
        <button class="btn" id="btnLoad">Load role</button>
        <button class="btn" id="btnSelectAll">Select all</button>
        <button class="btn" id="btnClear">Clear</button>
      </div>

      <div class="hint">1) Indsæt rolle → <b>Load role</b>  2) Vælg talenter  3) <b>Generate</b></div>
    </aside>

    <!-- COL 2: Talent picker -->
    <section class="col">
      <div class="field">
        <label>Talent Picker (<span id="countSel">0</span> selected)</label>
        <input id="filterInput" placeholder="Filter by name…"/>
      </div>
      <div id="talentList" class="list"></div>
    </section>

    <!-- COL 3: Slides preview -->
    <main class="col">
      <div class="slides" id="slides"></div>
      <div class="nav">
        <button class="btn ghost" id="navPrev">←</button>
        <button class="btn ghost" id="navNext">→</button>
      </div>
    </main>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
/* utilities */
const slidesEl=document.getElementById('slides');
let currentIndex=0; const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1500)}
function clearSlides(){slidesEl.innerHTML=''}
function setActive(i){const all=[...document.querySelectorAll('.slide')]; if(!all.length) return; all.forEach((el,idx)=>el.classList.toggle('active',idx===i)); currentIndex=Math.max(0,Math.min(i,all.length-1))}
function next(){setActive(currentIndex+1)} function prev(){setActive(currentIndex-1)}
['btnNext','navNext'].forEach(id=>document.getElementById(id).addEventListener('click',()=>next()));
['btnPrev','navPrev'].forEach(id=>document.getElementById(id).addEventListener('click',()=>prev()));
document.addEventListener('keydown',e=>{if(e.key==='ArrowRight')next(); if(e.key==='ArrowLeft')prev()});
document.getElementById('btnPrint').addEventListener('click',()=>window.print());
function escHtml(s){return String(s).replace(/[&<>\"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
function escAttr(s){return escHtml(s)}
const k=(v)=>v==null?'–':v;
const byId=(id)=>document.getElementById(id);

/* parse roleId from URL or id */
function parseRoleId(text){
  const s=(text||'').trim(); if(!s) return '';
  const m=s.match(/role\\/([a-f0-9\\-]{36})/i); return m?m[1]:s;
}

/* MOCK DATA – replace with real API later */
const MOCK={
 "b95af7ac-5a69-466d-9aa4-43baec5bb7be":{
  title:"Blacklane – International Faces",
  talents:[
   {id:"95a8c098-7a9c-451c-85bd-d129623fa9c6",name:"Hugo P",status:"IN_REVIEW",country:"Denmark",profile_url:"https://producer.selfcast.com/talent/95a8c098-7a9c-451c-85bd-d129623fa9c6",best_image:"https://via.placeholder.com/900x1200?text=Hugo",gallery:["https://via.placeholder.com/600x800?text=Hugo+1","https://via.placeholder.com/600x800?text=Hugo+2"],requested_uploads:[]},
   {id:"08f385e4-480e-4b81-ad95-99831896a520",name:"Hjalte IG",status:"IN_REVIEW",country:"Denmark",profile_url:"https://producer.selfcast.com/talent/08f385e4-480e-4b81-ad95-99831896a520",best_image:"https://via.placeholder.com/900x1200?text=Hjalte+IG",gallery:["https://via.placeholder.com/600x800?text=Hjalte+1"],requested_uploads:[]},
   {id:"133e8d11-064c-4a4a-8ca4-702592b6a9a5",name:"Ken S",status:"IN_REVIEW",country:"Denmark",profile_url:"https://producer.selfcast.com/talent/133e8d11-064c-4a4a-8ca4-702592b6a9a5",best_image:"https://via.placeholder.com/900x1200?text=Ken+S",gallery:["https://via.placeholder.com/600x800?text=Ken+1","https://via.placeholder.com/600x800?text=Ken+2","https://via.placeholder.com/600x800?text=Ken+3"],requested_uploads:[]},
   {id:"x1",name:"Anna S",status:"SHORTLISTED",country:"Germany",profile_url:"#",best_image:"https://via.placeholder.com/900x1200?text=Anna+S",gallery:["https://via.placeholder.com/600x800?text=Anna+1"]},
   {id:"x2",name:"Jonas K",status:"OPTION",country:"Sweden",profile_url:"#",best_image:"",gallery:[]},
   {id:"x3",name:"Maja L",status:"IN_DIALOG",country:"Denmark",profile_url:"#",best_image:"https://via.placeholder.com/900x1200?text=Maja+L",gallery:["https://via.placeholder.com/600x800?text=Maja+1"]},
   {id:"x4",name:"Noah B",status:"BOOKED",country:"Norway",profile_url:"#",best_image:"https://via.placeholder.com/900x1200?text=Noah+B",gallery:["https://via.placeholder.com/600x800?text=Noah+1"]}
  ]
 }
};
async function fetchRoleData(roleId) {
  // Kalder vores nye serverless endpoint (sikker token på serveren)
  const params = new URLSearchParams({ roleId });
  const r = await fetch(`/api/role?${params.toString()}`, { headers: { "Accept": "application/json" }});
  if (!r.ok) {
    const txt = await r.text().catch(()=>"");
    throw new Error(`API error ${r.status}: ${txt}`);
  }
  return r.json();
}

/* state */
let loadedRole=null;        // {roleId,title,talents[]}
let selectedIds=new Set();  // user-checked ids

function ensureSelectedImages(t){
  const imgs=[]; if(t.best_image) imgs.push(t.best_image); (t.gallery||[]).forEach(u=>imgs.push(u));
  if(!t._selectedImages) t._selectedImages=imgs.slice(0,3);
}

/* render picker list */
function renderPicker(){
  const list=byId('talentList'); list.innerHTML='';
  const q=byId('filterInput').value.trim().toLowerCase();
  const statuses=[...document.querySelectorAll('.st:checked')].map(x=>x.value);
  const min=parseInt(byId('minImages').value||'0',10);

  let items=(loadedRole?.talents||[]).filter(t=>{
    const okStatus=!statuses.length||statuses.includes(String(t.status||'').toUpperCase());
    const imgCount=(t.best_image?1:0)+(t.gallery?t.gallery.length:0);
    const okImg=imgCount>=min;
    const okName=!q || (t.name||'').toLowerCase().includes(q);
    return okStatus && okImg && okName;
  });

  items.forEach(t=>{
    ensureSelectedImages(t);
    const row=document.createElement('div'); row.className='rowPick';
    row.innerHTML=`
      <input type="checkbox" ${selectedIds.has(t.id)?'checked':''} data-id="${escAttr(t.id)}"/>
      <div style="display:flex;gap:10px;align-items:center">
        <img src="${escAttr(t._selectedImages[0]||t.best_image||'https://via.placeholder.com/120x120?text=No+img')}" alt="${escAttr(t.name)}"/>
        <div>
          <div style="font-weight:700">${escHtml(t.name)}</div>
          <div class="hint">${escHtml(t.country||'')} • <span class="tag">${escHtml(t.status||'')}</span></div>
        </div>
      </div>
      <a class="tag" href="${escAttr(t.profile_url||'#')}" target="_blank">Profile ↗</a>`;
    row.querySelector('input').addEventListener('change',e=>{
      if(e.target.checked) selectedIds.add(t.id); else selectedIds.delete(t.id);
      byId('countSel').textContent=selectedIds.size;
    });
    list.appendChild(row);
  });

  byId('countSel').textContent=selectedIds.size;
}

/* slides building */
function buildCover(title,count,roleUrl,label){
  const s=document.createElement('section'); s.className='slide';
  s.innerHTML=`<div class="deck"><div class="frame cover"><div class="inner">
    <div class="title">${escHtml(title)}</div>
    <div class="subtitle">${escHtml(label)} • ${count} talents</div>
    <div class="meta">${roleUrl?`<a href="${escAttr(roleUrl)}" target="_blank">Open role ↗</a> • `:''}${new Date().toLocaleDateString()}</div>
  </div></div></div>`;
  slidesEl.appendChild(s);
}
function buildGrid(talents, roleUrl){
  const s=document.createElement('section'); s.className='slide';
  const cards=talents.map(t=>`<div class="card">
    <img src="${escAttr((t._selectedImages&&t._selectedImages[0])||t.best_image||'https://via.placeholder.com/600x400?text=Image')}" alt="${escAttr(t.name)}"/>
    <div class="info"><div class="name">${escHtml(t.name)}</div><div class="hint">${escHtml(t.country||'')}</div></div>
  </div>`).join('');
  const more=roleUrl?`<a class="btn" href="${escAttr(roleUrl)}" target="_blank">View all candidates ↗</a>`:'';
  s.innerHTML=`<div class="deck"><div class="frame"><div class="inner">
    <div style="display:flex;justify-content:space-between;align-items:end;margin-bottom:8px"><h2 style="margin:0">Overview</h2><div>${more}</div></div>
    <div class="grid">${cards}</div>
  </div></div></div>`;
  slidesEl.appendChild(s);
}
function buildTalent(t){
  ensureSelectedImages(t);
  const s=document.createElement('section'); s.className='slide';
  const all=[...(t.best_image?[t.best_image]:[]), ...((t.gallery)||[])];
  const pick=all.map(u=>`<label class="thumb"><input type="checkbox" ${t._selectedImages.includes(u)?'checked':''} data-url="${escAttr(u)}"/><img src="${escAttr(u)}" alt="${escAttr(t.name)}"/></label>`).join('');
  const reqs=(t.requested_uploads||[]).map(r=>`<a href="${escAttr(r.url)}" target="_blank">${escHtml(r.label||r.type||'Requested')}</a>`).join('');
  s.innerHTML=`<div class="deck"><div class="frame"><div class="inner">
    <div class="talent">
      <div class="hero"><img src="${escAttr(t._selectedImages[0]||t.best_image||'https://via.placeholder.com/900x1200?text=Image')}" alt="${escAttr(t.name)}"/></div>
      <div class="facts">
        <div class="box"><h2 style="margin:0 0 6px 0">${escHtml(t.name)} <span class="badge">${escHtml(t.status||'')}</span></h2>
          <div class="kvs">
            <div class="k">Country</div><div>${escHtml(t.country||'')}</div>
            <div class="k">Profile</div><div>${t.profile_url?`<a href="${escAttr(t.profile_url)}" target="_blank">Open profile ↗</a>`:'—'}</div>
          </div>
        </div>
        <div class="box"><div class="hint" style="margin-bottom:6px">Requested videos & photos</div>
          <div class="links">${reqs||'<span class="hint">No requested uploads</span>'}</div>
        </div>
        <div class="box"><div class="hint" style="margin-bottom:6px">Select images for this talent (first becomes hero)</div>
          <div class="pick">${pick||'<span class="hint">No images</span>'}</div>
        </div>
      </div>
    </div>
  </div></div></div>`;
  s.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change',()=>{
      const url=cb.getAttribute('data-url');
      if(cb.checked){ if(!t._selectedImages.includes(url)) t._selectedImages.push(url); }
      else{ t._selectedImages=t._selectedImages.filter(x=>x!==url); }
      s.querySelector('.hero img').src=(t._selectedImages[0]||t.best_image||'https://via.placeholder.com/900x1200?text=Image');
    });
  });
  slidesEl.appendChild(s);
}
function buildFooter(){
  const s=document.createElement('section'); s.className='slide';
  s.innerHTML=`<div class="deck"><div class="frame"><div class="inner" style="display:grid;align-content:center;gap:10px">
    <h2 style="margin:0">Next steps</h2>
    <div class="hint">Share live link or export PDF. Use profile links to review full materials.</div>
  </div></div></div>`;
  slidesEl.appendChild(s);
}

/* actions */
byId('btnLoad').addEventListener('click', async ()=>{
  const roleId=parseRoleId(byId('inpRole').value);
  if(!roleId){ toast('Paste a role URL or id'); return; }
  loadedRole=await fetchRole(roleId);
  selectedIds=new Set( (loadedRole.talents||[]).map(t=>t.id) ); // default select all
  renderPicker();
  toast(`Loaded role • ${loadedRole.talents.length} talents`);
});

['filterInput', 'minImages'].forEach(id=>byId(id).addEventListener('input',renderPicker));
document.querySelectorAll('.st').forEach(cb=>cb.addEventListener('change',renderPicker));

byId('btnSelectAll').addEventListener('click',()=>{
  (loadedRole?.talents||[]).forEach(t=>selectedIds.add(t.id));
  renderPicker();
});
byId('btnClear').addEventListener('click',()=>{
  selectedIds.clear(); renderPicker();
});

function getSelectedTalents(){
  const map=new Map((loadedRole?.talents||[]).map(t=>[t.id,t]));
  const arr=[...selectedIds].map(id=>map.get(id)).filter(Boolean);
  return arr;
}

/* Generate slides from CHECKED talents */
async function generate(){
  clearSlides();
  if(!loadedRole){ toast('Load a role first'); return; }
  const title=byId('inpTitle').value.trim()||'Casting Presentation';
  const statuses=[...document.querySelectorAll('.st:checked')].map(x=>x.value);
  const label=statuses.length?('Statuses: '+statuses.join(', ')):'All statuses';
  const roleUrl=`https://producer.selfcast.com/production/ROLE/role/${loadedRole.roleId}`;
  const talents=getSelectedTalents();
  buildCover(title, talents.length, roleUrl, label);
  buildGrid(talents, roleUrl);
  talents.forEach(buildTalent);
  buildFooter();
  setActive(0); toast('Deck generated');
}
['btnGenerate','btnLoad'].forEach(id=>byId(id).addEventListener('click',()=>{}));
byId('btnGenerate').addEventListener('click',generate);

/* initial state */
setActive(0);
</script>
</body>
</html>
