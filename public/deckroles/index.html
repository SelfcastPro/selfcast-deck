import React, { useMemo, useRef, useState } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Switch } from "@/components/ui/switch";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Separator } from "@/components/ui/separator";
import { Download, Plus, Trash2, Upload, Link as LinkIcon, Filter } from "lucide-react";
import { motion } from "framer-motion";

/**
 * Selfcast – Role Presentation Builder
 * Single-file React component that lets you:
 * - Add roles using the producer.selfcast.com Role URL
 * - Paste/import a CSV of talents for each role (or add manually)
 * - Group talents by pipeline stage: Option, In review, Shortlisted, In dialog, Booked
 * - Render a clean, printable presentation (web + PDF-friendly)
 * - Export via native Print-to-PDF or one-click HTML->PDF
 *
 * CSV columns (header optional, order flexible – matched by name):
 * name, profileUrl, imageUrl, notes, stage
 * stage must be one of: option|in review|shortlisted|in dialog|booked (case-insensitive)
 *
 * Design notes:
 * - Tailwind + shadcn/ui
 * - Crisp grid cards, large imagery, strong whitespace
 * - Final slide: “THIS IS HOW IT WORKS!” + Selfcast contact info
 */

const STAGES = [
  { key: "option", label: "Option" },
  { key: "in review", label: "In review" },
  { key: "shortlisted", label: "Shortlisted" },
  { key: "in dialog", label: "In dialog" },
  { key: "booked", label: "Booked" },
] as const;

type StageKey = typeof STAGES[number]["key"];

interface Talent {
  id: string;
  name: string;
  profileUrl?: string;
  imageUrl?: string;
  notes?: string;
  stage: StageKey;
}

interface Role {
  id: string;
  title: string;
  roleUrl?: string;
  heroImageUrl?: string;
  stageFilter: StageKey | "all";
  talents: Talent[];
}

export default function RolePresentationBuilder() {
  const [brand, setBrand] = useState({
    logoUrl: "",
    useWordmark: true,
    wordmark: "SELFCAST",
    subtitle: "Casting Made Easy",
  });
  const [contact, setContact] = useState({
    person: "",
    email: "",
    phone: "",
  });
  const [roles, setRoles] = useState<Role[]>([{
    id: crypto.randomUUID(),
    title: "Mother and daughter",
    roleUrl: "https://producer.selfcast.com/production/175e757e-470c-4367-b674-c588f44f18d8/role/ef4e98c5-09ca-48ef-9cd2-35ff87a883e4",
    heroImageUrl: "",
    stageFilter: "all",
    talents: [],
  }, {
    id: crypto.randomUUID(),
    title: "Couple age 65+",
    roleUrl: "https://producer.selfcast.com/production/175e757e-470c-4367-b674-c588f44f18d8/role/59f7f37c-e20f-4662-b992-7e2af363a849",
    heroImageUrl: "",
    stageFilter: "all",
    talents: [],
  }, {
    id: crypto.randomUUID(),
    title: "Men age 20–30",
    roleUrl: "https://producer.selfcast.com/production/175e757e-470c-4367-b674-c588f44f18d8/role/20c3c9d1-65a0-4fb1-88cb-aa1fc3bcaf58",
    heroImageUrl: "",
    stageFilter: "all",
    talents: [],
  }]);

  const [showHowItWorks, setShowHowItWorks] = useState(true);
  const printRef = useRef<HTMLDivElement>(null);

  function addRole() {
    setRoles(r => ([...r, {
      id: crypto.randomUUID(),
      title: "New role",
      roleUrl: "",
      heroImageUrl: "",
      stageFilter: "all",
      talents: [],
    }]));
  }

  function removeRole(id: string) {
    setRoles(r => r.filter(x => x.id !== id));
  }

  function updateRole<K extends keyof Role>(id: string, key: K, value: Role[K]) {
    setRoles(r => r.map(x => x.id === id ? { ...x, [key]: value } : x));
  }

  function addTalent(roleId: string) {
    setRoles(r => r.map(role => role.id === roleId ? {
      ...role,
      talents: [...role.talents, {
        id: crypto.randomUUID(),
        name: "New Talent",
        stage: "option",
      }],
    } : role));
  }

  function updateTalent(roleId: string, talentId: string, patch: Partial<Talent>) {
    setRoles(r => r.map(role => role.id === roleId ? {
      ...role,
      talents: role.talents.map(t => t.id === talentId ? { ...t, ...patch } : t),
    } : role));
  }

  function removeTalent(roleId: string, talentId: string) {
    setRoles(r => r.map(role => role.id === roleId ? {
      ...role,
      talents: role.talents.filter(t => t.id !== talentId),
    } : role));
  }

  function parseCSV(text: string): Talent[] {
    const rows = text.trim().split(/\r?\n/).filter(Boolean);
    if (rows.length === 0) return [];

    // detect header
    const first = rows[0].split(",").map(s => s.trim().toLowerCase());
    const looksLikeHeader = ["name", "profileurl", "imageurl", "notes", "stage"].some(h => first.includes(h));

    const start = looksLikeHeader ? 1 : 0;
    const toStage = (s: string): StageKey => {
      const v = s?.trim().toLowerCase();
      const hit = STAGES.find(x => x.key === v);
      return (hit?.key ?? "option") as StageKey;
    };

    const mapRow = (line: string) => {
      // naive CSV split; good enough for simple pastes
      const parts = line.split(",").map(s => s.trim());
      const [c0, c1, c2, c3, c4] = parts;
      let name = c0, profileUrl = c1, imageUrl = c2, notes = c3, stage = c4;
      if (looksLikeHeader) {
        // if header existed, rely on position
      }
      return {
        id: crypto.randomUUID(),
        name: name || "",
        profileUrl: profileUrl || "",
        imageUrl: imageUrl || "",
        notes: notes || "",
        stage: toStage(stage || "option"),
      } as Talent;
    };

    return rows.slice(start).map(mapRow).filter(t => t.name);
  }

  function handleCSVImport(roleId: string, csv: string) {
    const list = parseCSV(csv);
    setRoles(r => r.map(role => role.id === roleId ? { ...role, talents: [...role.talents, ...list] } : role));
  }

  function printPDF() {
    window.print();
  }

  const StageBadge: React.FC<{ stage: StageKey }> = ({ stage }) => (
    <span className="text-[11px] rounded-full px-2 py-0.5 border border-black/10">
      {STAGES.find(s => s.key === stage)?.label}
    </span>
  );

  const HeaderBrand = () => (
    <div className="flex items-center gap-3">
      {brand.logoUrl ? (
        <img src={brand.logoUrl} alt="Logo" className="h-8 w-auto rounded" />
      ) : null}
      {brand.useWordmark && (
        <div className="leading-tight">
          <div className="tracking-[0.2em] text-xl font-black">{brand.wordmark}</div>
          {brand.subtitle ? <div className="text-xs opacity-70">{brand.subtitle}</div> : null}
        </div>
      )}
    </div>
  );

  const Presentation: React.FC = () => (
    <div ref={printRef} className="bg-white text-black">
      {/* Cover */}
      <section className="min-h-[75vh] p-10 flex flex-col justify-between print:break-after-page">
        <div className="flex justify-between items-start">
          <HeaderBrand />
          <div className="text-right text-sm opacity-60">
            <div>{new Date().toLocaleDateString()}</div>
            <div>Role Presentation</div>
          </div>
        </div>
        <div className="mt-16">
          <h1 className="text-4xl font-extrabold mb-2">Selected Roles</h1>
          <p className="text-lg opacity-80">Auto-generated from Selfcast role links.</p>
          <div className="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
            {roles.map(r => (
              <Card key={r.id} className="rounded-2xl shadow-sm border-black/10">
                <CardHeader>
                  <CardTitle className="text-base">{r.title}</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="text-xs break-all opacity-70">
                    <LinkIcon className="inline h-3 w-3 mr-1" />{r.roleUrl}
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>
        <div className="text-sm opacity-70">
          <Separator className="my-4" />
          <div>Contact: {contact.person || "—"} {contact.email ? `· ${contact.email}` : ""} {contact.phone ? `· ${contact.phone}` : ""}</div>
        </div>
      </section>

      {/* Per-role pages */}
      {roles.map((role, idx) => {
        const talents = role.stageFilter === "all" ? role.talents : role.talents.filter(t => t.stage === role.stageFilter);
        return (
          <section key={role.id} className="p-10 print:break-after-page">
            <div className="flex items-start justify-between">
              <div>
                <h2 className="text-3xl font-extrabold">{role.title}</h2>
                <div className="text-sm opacity-70 break-all flex items-center gap-2 mt-1">
                  <LinkIcon className="h-3 w-3" />
                  <a href={role.roleUrl} target="_blank" rel="noreferrer" className="underline">Open role</a>
                </div>
              </div>
              <div className="text-sm opacity-70 flex items-center gap-2">
                <Filter className="h-4 w-4" />
                <span>
                  Showing: <strong>{role.stageFilter === "all" ? "All stages" : STAGES.find(s => s.key === role.stageFilter)?.label}</strong>
                </span>
              </div>
            </div>

            {role.heroImageUrl ? (
              <img src={role.heroImageUrl} alt="Role hero" className="mt-6 w-full h-64 object-cover rounded-2xl border border-black/10" />
            ) : null}

            <div className="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              {talents.length === 0 ? (
                <div className="col-span-full text-center opacity-60">No talents added yet.</div>
              ) : talents.map(t => (
                <motion.div key={t.id} layout initial={{ opacity: 0, y: 6 }} animate={{ opacity: 1, y: 0 }}>
                  <Card className="rounded-2xl overflow-hidden border-black/10">
                    {t.imageUrl ? (
                      <img src={t.imageUrl} alt={t.name} className="w-full h-56 object-cover" />
                    ) : (
                      <div className="w-full h-56 bg-black/5 flex items-center justify-center text-sm">No image</div>
                    )}
                    <CardContent className="p-4">
                      <div className="flex items-start justify-between gap-3">
                        <div>
                          <div className="font-semibold leading-tight">{t.name}</div>
                          {t.notes ? <div className="text-xs opacity-70 mt-0.5">{t.notes}</div> : null}
                        </div>
                        <StageBadge stage={t.stage} />
                      </div>
                      {t.profileUrl ? (
                        <a href={t.profileUrl} target="_blank" rel="noreferrer" className="text-xs underline inline-flex items-center gap-1 mt-2">
                          <LinkIcon className="h-3 w-3" /> Open profile
                        </a>
                      ) : null}
                    </CardContent>
                  </Card>
                </motion.div>
              ))}
            </div>
          </section>
        );
      })}

      {showHowItWorks && (
        <section className="p-10 print:break-after-page">
          <h2 className="text-3xl font-extrabold mb-6">THIS IS HOW IT WORKS!</h2>
          <div className="space-y-3 text-[15px] leading-6">
            <p><strong>When you click Decline</strong><br/>The Talents receive a message that they are not selected and they disappear from your list.</p>
            <p><strong>When you click Requested videos/photos next to the Talents</strong><br/>You can view videos and images uploaded for this specific job. It could be a monologue, a new presentation or pictures showing how the Talent looks like right now...</p>
            <p><strong>When you click on the Talent's picture</strong><br/>You can see the Talent's profile and information.</p>
            <p><strong>Add to Shortlist</strong><br/>Shortlist the Talents you want to pass on in the process. You can also choose to book a Talent. We can see in our system that the talent has been passed on. If you need to present the Talents to others, you can share the URL of all the Talents or a specific talent by sharing the URL of the Talent profile.</p>
            <p><strong>Selection of talents</strong></p>
          </div>
          <Separator className="my-6" />
          <div className="text-sm opacity-80">
            <div>If you need assistance:</div>
            <div>
              Contact {contact.person || "Selfcast"}
              {contact.email ? ` · ${contact.email}` : ""}
              {contact.phone ? ` · ${contact.phone}` : ""}
            </div>
          </div>
        </section>
      )}
    </div>
  );

  return (
    <div className="mx-auto max-w-6xl p-6 space-y-8">
      <div className="flex items-start justify-between gap-6">
        <HeaderBrand />
        <div className="flex items-center gap-2">
          <Button onClick={printPDF} className="rounded-2xl"><Download className="h-4 w-4 mr-2"/>Download PDF</Button>
        </div>
      </div>

      <Tabs defaultValue="builder">
        <TabsList className="grid grid-cols-3 w-full">
          <TabsTrigger value="builder">Builder</TabsTrigger>
          <TabsTrigger value="preview">Preview</TabsTrigger>
          <TabsTrigger value="help">Help</TabsTrigger>
        </TabsList>

        {/* Builder */}
        <TabsContent value="builder" className="space-y-8">
          <Card className="rounded-2xl">
            <CardHeader>
              <CardTitle>Brand</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div className="md:col-span-2">
                  <label className="text-sm">Logo URL (optional)</label>
                  <Input placeholder="https://…/logo.png" value={brand.logoUrl} onChange={e => setBrand({ ...brand, logoUrl: e.target.value })} />
                </div>
                <div className="flex items-center gap-3 mt-6 md:mt-0">
                  <Switch checked={brand.useWordmark} onCheckedChange={v => setBrand({ ...brand, useWordmark: v })} />
                  <span className="text-sm">Show wordmark</span>
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label className="text-sm">Wordmark text</label>
                  <Input value={brand.wordmark} onChange={e => setBrand({ ...brand, wordmark: e.target.value })} />
                </div>
                <div>
                  <label className="text-sm">Subtitle</label>
                  <Input value={brand.subtitle} onChange={e => setBrand({ ...brand, subtitle: e.target.value })} />
                </div>
              </div>
            </CardContent>
          </Card>

          <Card className="rounded-2xl">
            <CardHeader>
              <CardTitle>Contact</CardTitle>
            </CardHeader>
            <CardContent className="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label className="text-sm">Contact person</label>
                <Input value={contact.person} onChange={e => setContact({ ...contact, person: e.target.value })} />
              </div>
              <div>
                <label className="text-sm">Email</label>
                <Input value={contact.email} onChange={e => setContact({ ...contact, email: e.target.value })} />
              </div>
              <div>
                <label className="text-sm">Phone</label>
                <Input value={contact.phone} onChange={e => setContact({ ...contact, phone: e.target.value })} />
              </div>
            </CardContent>
          </Card>

          <div className="space-y-6">
            {roles.map((role, idx) => (
              <Card key={role.id} className="rounded-2xl">
                <CardHeader className="flex flex-row items-center justify-between">
                  <CardTitle className="w-full">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 items-center">
                      <Input value={role.title} onChange={e => updateRole(role.id, "title", e.target.value)} />
                      <div className="flex gap-3">
                        <Input placeholder="Role link (producer.selfcast.com/…)" value={role.roleUrl || ""} onChange={e => updateRole(role.id, "roleUrl", e.target.value)} />
                        <a className="text-sm underline whitespace-nowrap flex items-center" href={role.roleUrl} target="_blank" rel="noreferrer">Open</a>
                      </div>
                    </div>
                  </CardTitle>
                  <Button variant="ghost" onClick={() => removeRole(role.id)}><Trash2 className="h-4 w-4"/></Button>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
                    <div className="md:col-span-2">
                      <label className="text-sm">Hero image URL (optional)</label>
                      <Input placeholder="Paste role header image URL (top of the role page)" value={role.heroImageUrl || ""} onChange={e => updateRole(role.id, "heroImageUrl", e.target.value)} />
                    </div>
                    <div className="flex items-center gap-2">
                      <Filter className="h-4 w-4"/>
                      <select className="border rounded-md px-2 py-2 text-sm" value={role.stageFilter} onChange={e => updateRole(role.id, "stageFilter", e.target.value as any)}>
                        <option value="all">Show: All stages</option>
                        {STAGES.map(s => <option key={s.key} value={s.key}>Show: {s.label}</option>)}
                      </select>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="space-y-2">
                      <div className="text-sm font-medium">Add / edit talents</div>
                      <div className="space-y-3 max-h-[360px] overflow-auto pr-1">
                        {role.talents.map(t => (
                          <div key={t.id} className="grid grid-cols-12 gap-2 items-center">
                            <Input className="col-span-3" placeholder="Name" value={t.name} onChange={e => updateTalent(role.id, t.id, { name: e.target.value })} />
                            <Input className="col-span-4" placeholder="Profile URL" value={t.profileUrl || ""} onChange={e => updateTalent(role.id, t.id, { profileUrl: e.target.value })} />
                            <Input className="col-span-4" placeholder="Image URL" value={t.imageUrl || ""} onChange={e => updateTalent(role.id, t.id, { imageUrl: e.target.value })} />
                            <select className="col-span-1 border rounded-md px-2 py-2 text-xs" value={t.stage} onChange={e => updateTalent(role.id, t.id, { stage: e.target.value as StageKey })}>
                              {STAGES.map(s => <option key={s.key} value={s.key}>{s.label}</option>)}
                            </select>
                            <Input className="col-span-9" placeholder="Notes (optional)" value={t.notes || ""} onChange={e => updateTalent(role.id, t.id, { notes: e.target.value })} />
                            <Button variant="ghost" className="col-span-3" onClick={() => removeTalent(role.id, t.id)}><Trash2 className="h-4 w-4 mr-1"/>Remove</Button>
                          </div>
                        ))}
                      </div>
                      <Button onClick={() => addTalent(role.id)} className="rounded-2xl mt-2"><Plus className="h-4 w-4 mr-2"/>Add talent</Button>
                    </div>

                    <div className="space-y-2">
                      <div className="text-sm font-medium">Bulk import (CSV)</div>
                      <Textarea placeholder={`name, profileUrl, imageUrl, notes, stage\nJane Doe, https://producer.selfcast.com/talent/xxxx, https://…/jane.jpg, Great smile, Shortlisted`} rows={10} onBlur={(e) => handleCSVImport(role.id, e.target.value)} />
                      <div className="text-xs opacity-70">Tip: paste a CSV exported from your role list, or build it quickly by copying rows from a spreadsheet.</div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
            <Button onClick={addRole} className="rounded-2xl"><Plus className="h-4 w-4 mr-2"/>Add role</Button>
          </div>
        </TabsContent>

        {/* Preview */}
        <TabsContent value="preview">
          <Presentation />
        </TabsContent>

        {/* Help */}
        <TabsContent value="help" className="prose max-w-none">
          <h2>How to use</h2>
          <ol>
            <li>Paste your <strong>Role link</strong> (producer.selfcast.com/…/role/…).</li>
            <li>(Optional) Paste a <strong>Hero image URL</strong> — you can copy the top image URL from the Role page.</li>
            <li>Import talents via <strong>CSV</strong> or add them manually. Use stages: Option, In review, Shortlisted, In dialog, Booked.</li>
            <li>Go to <strong>Preview</strong> to see the presentation pages.</li>
            <li>Click <strong>Download PDF</strong> (uses your browser’s Print to PDF).</li>
          </ol>
          <h3>Branding</h3>
          <p>Either paste a <strong>Logo URL</strong> or toggle the wordmark. Default wordmark is “SELFCAST”.</p>
          <h3>Contact block</h3>
          <p>Fill in contact person, email and phone — shown on cover + final slide.</p>
        </TabsContent>
      </Tabs>

      <style>{`
        /* Print optimizations */
        @media print {
          @page { margin: 16mm; }
          html, body { background: white; }
          button, [role="tablist"], .shadcn-no-print { display: none !important; }
          .print\\:break-after-page { break-after: page; }
        }
      `}</style>
    </div>
  );
}
